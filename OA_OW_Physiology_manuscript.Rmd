---
title: "Global change differentially modulates physiological plasticity of tropical reef-building corals"
date: "*Last run on `r format(Sys.time(), '%d %B %Y')`*"
output: 
  html_document:
    theme: simplex
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

<style>
  h2{color: teal !important}
  h1{color: navy !important}
  body{background-color: gray95 !important}
</style>

<br/>

<center>
**This is a working document for all the coral physiology data manipulation, analysis, and visualization of the physiology manuscript. The document includes all figures, tables, supplemental materials, methods, and results for the manuscript. Each major analysis is separated by the tabs on the left.** 
</center>

<br/>

---

**Potential target journals to submit:**

* Ecology
* Journal of Experimental Biology
* Global Change Biology
* Others?
  
---  

<br/>

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, options(knitr.kable.NA = ''))
options(warn = -1)

```

```{r packages, include=FALSE}

#library("devtools")
#install_github("vqv/ggbiplot") # need this to download ggbiplot if not already installed

## Packages to load
library(knitr)
library(readr)
library(broom)
library(ggplot2)
library(dplyr)
library(ggbiplot)
library(tidyr)
library(corrgram)
library(openxlsx)
library(plotly)
library(tidyverse)
library(vegan)
library(shiny)
library(Rmisc)
library(cowplot)
library(ggfortify)
library(finalfit)
library(kableExtra)
library(readr)
library(lmerTest)
library(vroom)
library(ggpubr)
library(magick)
library(Hmisc)
library(corrplot)
library(gridGraphics)
library(grid)
library(RColorBrewer)
library(wesanderson)
library(performance)
library(MASS)
library(png)
library(car)

## Source the custom functions necessary for running this script
source("Code/CustomFunctions.R")

```

```{r set formatting and labels, include=FALSE}

## Set some standards and units

# dodge width
dodge=position_dodge(width=0.3)
dodge2=position_dodge(width = 0.6)
jitter=position_jitter(width=0.1)

# set figure theme
theme_set(theme_pubr())

# set parameter labels
Tlab<-"Temperature (Â°C)"
alab<-expression(paste(italic("p"),"CO" [2]~ "("*mu,'atm)'))
dlab<-expression(paste("Cell density (10"^6,"cells cm"^-2,")"))
plab<-expression(paste("Total protein (mg cm"^-2,")"))
calab<-expression(paste("Carbohydrate (mg cm"^-2,")"))
clab<-expression(paste("Chlorophyll a ("*mu,"g cm"^-2,")"))
rlab<-expression(paste("Calcification rate (mg cm"^-2~"day"^-1,")"))
llab<-expression(paste("Total Lipid (mg cm"^-2,")"))
hlab<-expression(paste("Total Host (mg cm"^-2,")"))

# set the current date
date <- Sys.Date() 

```

```{r original dataframe adjustment, include=FALSE}

df <- read_csv("Data/Raw_data/phys_all_23March2021.csv") # read in full dataframe
df$X1 <- NULL

# rename a couple columns
names(df)[38]<-"carb"
names(df)[39]<-"lipid"
names(df)[17]<-"sum"
names(df)[34]<-"red" 

# set columns as factors
df$ftemp <- as.factor(df$ftemp)
df$fpco2 <- as.factor(df$fpco2)
df$colony <- as.factor(df$colony)
df$species <- factor(df$species, levels = c("S", "P", "A", "T")) # and reorder these

# replace some pCO2 values with ones we will use moving forward
df$fpco2 <- gsub("2800", "3300", df$fpco2)
df$fpco2 <- gsub("280", "300", df$fpco2)
df$fpco2 <- gsub("400", "420", df$fpco2)
df$fpco2 <- gsub("700", "680", df$fpco2)

# reorder factors for pCO2 and temp
df$fpco2 <- factor(df$fpco2, c("420", "T0", "300", "680", "3300"))
df$ftemp <- factor(df$ftemp, c("28", "T0", "31"))

# calculate phys parameters
df$den <- (df$den / 1000000) # adjust symbiont density to display 10^6 cells
df$chla <- (df$chla / df$SA) # standardize chla to surface area
df$host <- df$pro + df$carb + df$lipid # calculate total host energy reserves (sum of carb, protein, lipids)
df$treat[df$T0_T90 == "T0"] <- "T0" # replace T0 'treat' with T0 text
df$treat <- factor(df$treat, c("T0", "288_28", "311_31", "447_28", "405_31", "673_28", "701_31", "3285_28", "3309_31")) # adjust treatment levels

# add a new treat column for plotting (replacing actual treatment with number for better plotting - see plot XX)
df$treat2 <- df$treat
df$treat <- gsub("T0", 2, df$treat)
df$treat <- gsub("288_28", 4, df$treat)
df$treat <- gsub("311_31", 4, df$treat)
df$treat <- gsub("447_28", 6, df$treat)
df$treat <- gsub("405_31", 6, df$treat)
df$treat <- gsub("673_28", 8, df$treat)
df$treat <- gsub("701_31", 8, df$treat)
df$treat <- gsub("3285_28", 10, df$treat)
df$treat <- gsub("3309_31", 10, df$treat)
df$treat <- as.numeric(df$treat) # convert 'treat' column to numerics (again, this is for plotting only)

# inverse of colours (so lower colour depicts more bleached coral)
df$sum <- (df$sum * -1)
df$red <- (df$red * -1)
df$blue_bw5 <- (df$blue_bw5 * -1)
df$green_bw5 <- (df$green_bw5 * -1)

## modify dataframe for simplified version
df2 <- df[,c(1:13, 41, 14:16, 37:40, 42:43, 17)] # select columns of interest only
df2 <- gather(df2, param, value, den:sum) # make column of parameter and value
df2$param <- factor(df2$param, levels = c("pro", "carb", "lipid", "den", "chla", "host", "count")) # reorder parameters
df2$species <- revalue(x = df2$species, c("S" = "SSID", "P" = "PSTR", "A" = "PAST", "T" = "UTEN")) # rename the species codes
df2 <- subset(df2, species != "UTEN") # remove UTEN (omitted due to high mortality in some treatments)

## remote T0 samples from dataframe for models
df2_T90 <- subset(df2, T0_T90 == "T90")

## add treatment column
df2_T90$treat2 <- paste0(df2_T90$fpco2, df2_T90$temp)

```

```{r bootstrap model setup}

## Performing the parametric bootstrapping of the model:
bootnum = 1500 # set number of iterations (we used 2000) between 999 and 9999
seed = 3 # seed to make results replicatable (our seed was 3)
set.seed(3)

```

```{r create dataframe per parameter}

## Create a forloop to subset the data by each parameter and save as individual dataframes 

# make a list of parameter names
param_list <- levels(df2_T90$param)

# forloop for dataframes
for (p in 1:length(param_list)) {
  param_select <- param_list[p]
  df_subset <- subset(df2_T90, param == param_select) # subset the dataframe for only one parameter
  df_subset <- completeFun(df_subset, "value") # run function to remove any missing values
  df_subset$value <- as.numeric(df_subset$value)
  df_subset$ftemp <- droplevels(df_subset$ftemp)
  df_subset$fpco2 <- droplevels(df_subset$fpco2)
  df_subset$colony <- droplevels(df_subset$colony)
  df_subset$species <- droplevels(df_subset$species)
  assign(paste(param_select, "mod_df", sep = "_"), df_subset) # assign the data to dataframe named for each parameter 
}

```

```{r T90 df setup}

df_withT <- df %>% filter(T0_T90 == "T90") %>% droplevels()
df_90 <- subset(df_withT, species != "T") 
df_90 <- df_90[,-c(18:33)]
df_90 <- completeFun(df_90, "den")
df_90 <- completeFun(df_90, "host")
df_90 <- completeFun(df_90, "lipid")
df_90 <- completeFun(df_90, "carb")
df_90_l <- gather(df_90, param, value, 14:23)

## specific species dataframes
s_df <- subset(df_90, species == "S") 
p_df <- subset(df_90, species == "P") 
a_df <- subset(df_90, species == "A") 

```


## Principal component analyses {.tabset}

#### *Methods:*
Principal component analysis (PCA) (function *prcomp*) of scaled and centered physiological parameters (host carbohydrate, host lipid, host protein, algal endosymbiont chlorophyll a, algal endosymbiont cell density, holobiont calcification rate as previously for the same samples in Bove et al. (2019)) were employed to assess the relationship between physiological parameters and treatment conditions for each coral species. Main effects (temperature, *p*CO~2~, and reef environment) were evaluated with PERMANOVA using the *adonis2* function (*vegan* package; version `r packageVersion("vegan")`). An additional PERMANOVA was conducted on the combined physiology from all three species to compare species responses combined with treatments and reef environment. 

<br/>

#### *Results:*
Two principal components (PCs) explained approximately 66% of the variance in physiological responses of the *S. siderea* holobiont to ocean acidification and warming treatments (**Figure 1A**). PC1 was driven by differences in algal endosymbiont physiology (chlorophyll a, cell density), while PC2 represented an inverse relationship between host energy reserves (lipid, protein, carbohydrate) and calcification rates and colour intensities. Overall, lower *p*CO~2~ and temperature resulted in  higher *S. siderea* holobiont physiology (**Figure 1A**). Treatment *p*CO~2~ predominantly drove *S. siderea* physiological responses (p < 0.001; **Table S2**), while temperature and reef environment were not as strong of drivers in physiological responses (p > 0.01 and p > 0.01, respectively; **Table S2**). For *P. strigosa*, 74% of the variance in the holobiont responses to treatments was explained by two PCs (**Figure 1B**). PC1 explained most of the variation of physiological parameters with the exception of host lipid content, which was represented in PC2. Holobiont physiology of *P. strigosa* was clearly reduced under warming and was generally higher in the lower *p*CO~2~ treatments (**Figure 1B**). Treatment temperature (p < 0.001; **Table S2**), *p*CO~2~ (p < 0.01; **Table S2**), and natal reef environment all significantly drove coral holobiont physiology (p < 0.001; **Table S2**). Finally, the first two PCs explained about 59% of the total variance of the *P. astreoides* holobiont response to treatment (**Figure 1C**). Coral holobiont samples separated most clearly along PC1 driven primarily by calcification rate and algal endosymbiont density, while PC2 exhibited an inverse relationship between host total carbohydrate and colour intensity. Overall, lower *p*CO~2~ drove higher *P. astreoides* holobiont physiology, while elevated temperature resulted in greater holobiont physiology (**Figure 1C**). Temperature (p < 0.001; **Table S2**) and *p*CO~2~ (p < 0.001; **Table S2**) drove separations in *P. astreoides* holobiont physiology, while reef environment was nonsignificant (p = 0.82; **Table S2**).  

The first two PCs of the combined holobiont physiology explained about 62% of the total variance across samples (**Figure 4**). In general, fragments of *S. siderea* contained higher chlorophyll a content, host carbohydrate, and host lipid content, while *P. strigosa* fragments typically had greater host protein content accompanied with higher calcification rates, and fragments of *P. astreoides* were differentiated by their high symbiont densities (**Figure 4A; Table S5**). Despite coral species, coral holobiont physiology exhibited similar physiological responses to *p*CO~2~ and temperature treatments (**Figure 4B, 4C; Table S5**). As *p*CO~2~ or temperature increased, coral holobiont physiology was more constrained and exhibited similar physiological responses under stress. Further, corals from the inshore reef environment exhibited more constrained physiology than their offshore counterparts (**Figure S7; Table S5**).

<br/>
  
### *Siderastrea siderea*

```{r SSID PCA}

# set up the dataframe
s_df <- unique(s_df) # remove any duplicate rows
s_df_l <- gather(s_df, param, value, c(14:17,21:23))
s_df$fpco2 <- factor(s_df$fpco2, levels = c("300", "420", "680", "3300"))
sid_pca_df <- s_df[,c(14:17,21:23)]

# run the adonis
#s_pca_mod <- adonis2(sid_pca_df ~ reef * ftemp * fpco2, data = s_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
s_pca_mod <- adonis2(sid_pca_df ~ fpco2 + ftemp + reef, data = s_df, method = 'eu', permutations = bootnum)
s_pca_mod # view SSID adonis output

# extract pvalues
s_pval <- s_pca_mod["Pr(>F)"]

# perform principal component analysis (PCA)
s_pca <- prcomp(sid_pca_df, center = TRUE, scale= TRUE)

```

```{r SSID PCA plot, fig.height=8, fig.width=8}

# create labels for p values calculated above
s_pco2_pval <-substitute(italic(P[pCO[2]])==p, list(p = format(s_pval[1,1], digits = 2)))
s_temp_pval <-substitute(italic(P[temp])==p, list(p = format(s_pval[2,1], digits = 3)))
s_reef_pval <-substitute(italic(P[reef])==p, list(p = format(s_pval[3,1], digits = 2)))


# temperature
s_temp_pca <- autoplot(s_pca, data = s_df, 
         colour = "ftemp",
         #shape = "fpco2",
         shape = "ftemp",
         fill = "ftemp",               
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 1.5, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  #scale_shape_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
  scale_shape_manual("temperature", labels = c("28C", "31C"), values = c(21, 21)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", "#b2182b"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", NA))+
  guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.30, y = -0.38, label = deparse(s_temp_pval), parse = TRUE, size = 3) +
  ggtitle(expression(paste(bold("A)   "), italic("S. siderea"))))

# pco2
s_pco2_pca <- autoplot(s_pca, data = s_df, 
         colour = "fpco2",
         #shape = "ftemp",
         fill = "fpco2",
         shape = "fpco2",
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 1.5, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
    #scale_shape_manual("temperature", labels = c("28 C", "31 C"), values = c(19,21)) +
    scale_shape_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
    scale_fill_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
    scale_colour_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
    guides(color = guide_legend(nrow = 4, override.aes = list(linetype = c(0, 0, 0, 0)))) +
    theme(legend.background = element_rect(fill = "transparent", colour = NA)) +
    annotate("text", x = -0.30, y = -0.38, label = deparse(s_pco2_pval), parse = TRUE, size = 3)

# reef
s_reef_pca <- autoplot(s_pca, data = s_df, 
         colour = "reef",
         fill = "reef",
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = -0.6, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  scale_fill_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  guides(fill = FALSE, color = guide_legend(keyheight = 0.3, nrow = 2, override.aes = list(linetype = c(0, 0))), shape = guide_legend(nrow = 2, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.3, y = -0.38, label = deparse(s_reef_pval), parse = TRUE, size = 3) +
  ggtitle(expression(paste(bold("A)   "), italic("S. siderea"))))

```

<br/>
<br/>


### *Pseudodiploria strigosa*

```{r PSTR PCA}

# set up the dataframe
p_df <- unique(p_df) # remove duplicate rows
p_df_l <- gather(p_df, param, value, c(14:16,21:23))
p_df$fpco2 <- factor(p_df$fpco2, levels = c("300", "420", "680", "3300"))
dip_pca_df <- p_df[,c(14:17,21:23)]

# run the adonis
#p_pca_mod <- adonis2(dip_pca_df ~ reef * ftemp * fpco2, data = p_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
p_pca_mod <- adonis2(dip_pca_df ~ reef + fpco2 + ftemp, data = p_df, method = 'eu', permutations = bootnum)
p_pca_mod # view PSTR adonis output

# extract pvalues
p_pval <- p_pca_mod["Pr(>F)"]

# perform principal component analysis (PCA)
p_pca <- prcomp(dip_pca_df, center = TRUE, scale= TRUE)

```

```{r PSTR PCA plot, fig.height=8, fig.width=8}

# create labels for p values calculated above
p_reef_pval <-substitute(italic(P[reef])==p, list(p = format(p_pval[1,1], digits = 2)))
p_temp_pval <-substitute(italic(P[temp])==p, list(p = format(p_pval[2,1], digits = 3)))
p_pco2_pval <-substitute(italic(P[pCO[2]])==p, list(p = format(p_pval[3,1], digits = 2)))


# temperature
p_temp_pca <- autoplot(p_pca, data = p_df, 
         colour = "ftemp",
         #shape = "fpco2",
         shape = "ftemp",
         fill = "ftemp",               
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 0.5, 
         loadings.label.vjust = 0.6,
         loadings.label.repel = TRUE) +
  #scale_shape_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
  scale_shape_manual("temperature", labels = c("28C", "31C"), values = c(21, 21)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", "#b2182b"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", NA))+
  guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.13, y = -0.38, label = deparse(p_temp_pval), parse = TRUE, size = 3) +
  ggtitle(expression(paste(bold("B)   "), italic("P. strigosa"))))

# pco2
p_pco2_pca <- autoplot(p_pca, data = p_df, 
         colour = "fpco2",
         fill = "fpco2",
         #shape = "ftemp",
         shape = "fpco2",
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 0.5, 
         loadings.label.vjust = 0.6,
         loadings.label.repel = TRUE) +
    #scale_shape_manual("temperature", labels = c("28 C", "31 C"), values = c(19,21)) +
    scale_shape_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
    scale_fill_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
    scale_colour_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
    guides(color = guide_legend(nrow = 4, override.aes = list(linetype = c(0, 0, 0, 0)))) +
    theme(legend.background = element_rect(fill = "transparent", colour = NA)) +
    annotate("text", x = -0.28, y = -0.38, label = deparse(p_pco2_pval), parse = TRUE, size = 3)

# reef
p_reef_pca <- autoplot(p_pca, data = p_df, 
         colour = "reef",
         fill = "reef",
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = -0.6, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  scale_fill_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  guides(fill = FALSE, color = guide_legend(keyheight = 0.3, nrow = 2, override.aes = list(linetype = c(0, 0))), shape = guide_legend(nrow = 2, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.17, y = -0.38, label = deparse(p_reef_pval), parse = TRUE, size = 3) +
  ggtitle(expression(paste(bold("B)   "), italic("P. strigosa"))))

```

<br/>
<br/>


### *Porites astreoides*

```{r PAST PCA}

# set up the dataframe
a_df <- unique(a_df)
a_df <- a_df[-17,] # we have two from the same colony in 400_28 that are performing similarly so one is being removed (CFAD12)
a_df_l <- gather(a_df, param, value, c(14:16,21:23))
a_df$fpco2 <- factor(a_df$fpco2, levels = c("300", "420", "680", "3300"))
por_pca_df <- a_df[,c(14:16,18,21:23)]

# run the adonis
#a_pca_mod <- adonis2(por_pca_df ~ fpco2 * ftemp * reef, data = a_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
a_pca_mod <- adonis2(por_pca_df ~ reef + ftemp + fpco2, data = a_df, method = 'eu', permutations = bootnum)
a_pca_mod # view PAST adonis output

# extract pvalues
a_pval <- a_pca_mod["Pr(>F)"]

# perform principal component analysis (PCA)
a_pca <- prcomp(por_pca_df, center = TRUE, scale= TRUE)

```

```{r PAST PCA plot, fig.height=8, fig.width=8}

# create labels for p values calculated above
a_reef_pval <-substitute(italic(P[reef])==p, list(p = format(a_pval[1,1], digits = 2)))
a_temp_pval <-substitute(italic(P[temp])==p, list(p = format(a_pval[2,1], digits = 3)))
a_pco2_pval <-substitute(italic(P[pCO[2]])==p, list(p = format(a_pval[3,1], digits = 2)))


# temperature
a_temp_pca <- autoplot(a_pca, data = a_df, 
         colour = "ftemp",
         #shape = "fpco2",
         shape = "ftemp",
         fill = "ftemp",               
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = -0.6, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  #scale_shape_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
  scale_shape_manual("temperature", labels = c("28C", "31C"), values = c(21, 21)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", "#b2182b"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", NA))+
  guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.22, y = -0.44, label = deparse(a_temp_pval), parse = TRUE, size = 3) +
  ggtitle(expression(paste(bold("C)   "), italic("P. astreoides"))))

# pco2
a_pco2_pca <- autoplot(a_pca, data = a_df, 
         colour = "fpco2",
         fill = "fpco2",
         #shape = "ftemp",
         shape = "fpco2",
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = -0.6, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
    #scale_shape_manual("temperature", labels = c("28 C", "31 C"), values = c(19,21)) +
    scale_shape_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
    scale_fill_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
    scale_colour_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
    guides(color = guide_legend(nrow = 4, override.aes = list(linetype = c(0, 0, 0, 0)))) +
    theme(legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.167, y = -0.5, label = deparse(a_pco2_pval), parse = TRUE, size = 3)

# reef
a_reef_pca <- autoplot(a_pca, data = a_df, 
         colour = "reef",
         fill = "reef",
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = -0.6, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  scale_fill_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  guides(fill = FALSE, color = guide_legend(keyheight = 0.3, nrow = 2, override.aes = list(linetype = c(0, 0))), shape = guide_legend(nrow = 2, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.245, y = -0.38, label = deparse(a_reef_pval), parse = TRUE, size = 3) +
  ggtitle(expression(paste(bold("C)   "), italic("P. astreoides"))))

```

<br/>
<br/>


### **Figure 1**

```{r PCA plot, fig.height=7, fig.width=13}

temp_PCA <- ggarrange(s_temp_pca, p_temp_pca, a_temp_pca, ncol = 3, common.legend = TRUE, legend = "right")
pCO2_PCA <- ggarrange(s_pco2_pca, p_pco2_pca, a_pco2_pca, ncol = 3, common.legend = TRUE, legend = "right")

ggarrange(temp_PCA, pCO2_PCA, nrow = 2) +
  ggsave("Figures/Final_Figures/Figure1_PhysPCA.pdf", width = 13, height = 7) +
  ggsave("Figures/Final_Figures/Figure1_PhysPCA.png", width = 13, height = 7)


```

**Figure 1.** Principal component analysis (PCA) of all coral holobiont physiological parameters for (**A**) *S. siderea*, (**B**) *P. strigosa*, and (**C**) *P. astreoides* after 93 days of exposure to different temperature and *p*CO~2~ treatments. PCAs in the top row are depicted by temperature treatment for each species (28$^\circ$ C blue; 31$^\circ$ C red) and the bottom row of PCAs are depicted by *p*CO~2~ for each species (280 $\mu$atm light purple; 400 $\mu$atm dark purple; 700 $\mu$atm light orange; 2800 $\mu$atm dark orange). Arrows represent significant (p < 0.05) correlation vectors for physiological parameters and ellipses represent 95% confidence based on multivariate t-distributions.

<br/>
<br/>

### **Figure 4**

```{r all PCA}

# set up the dataframe
all_df <- unique(df_90) # remove any duplicate rows
all_df_l <- gather(all_df, param, value, c(14:17,21:23))
all_df$fpco2 <- factor(all_df$fpco2, levels = c("300", "420", "680", "3300"))
all_pca_df <- all_df[,c(14:17,21:23)]

# run the adonis
#all_pca_mod <- adonis2(all_pca_df ~ reef * ftemp * fpco2 * species, data = all_df, method = 'eu', permutations = bootnum) # below is the model with non sig interactions removed:
all_pca_mod <- adonis2(all_pca_df ~ fpco2 + ftemp + reef + species + ftemp:species + fpco2:species + reef:species, data = all_df, method = 'eu', permutations = bootnum)
all_pca_mod # view all adonis output

# extract pvalues
all_pval <- all_pca_mod["Pr(>F)"]

# perform principal component analysis (PCA)
all_pca <- prcomp(all_pca_df, center = TRUE, scale= TRUE)

```

```{r all PCA plot, fig.height=8, fig.width=8}

# create labels for p values calculated above
all_pco2_pval <-substitute(italic(P[pCO[2]])==p, list(p = format(all_pval[1,1], digits = 2)))
all_temp_pval <-substitute(italic(P[temp])==p, list(p = format(all_pval[2,1], digits = 3)))
all_reef_pval <-substitute(italic(P[reef])==p, list(p = format(all_pval[3,1], digits = 2)))
all_species_pval <-substitute(italic(P[species])==p, list(p = format(all_pval[4,1], digits = 2)))
all_s_pco2_pval <-substitute(italic(P[species~X~pCO[2]])==p, list(p = format(all_pval[5,1], digits = 2)))
all_s_reef_pval <-substitute(italic(P[species~X~reef])==p, list(p = format(all_pval[6,1], digits = 2)))
all_s_temp_pval <-substitute(italic(P[species~X~temp])==p, list(p = format(all_pval[7,1], digits = 3)))


# species
species_pca_plot <- autoplot(all_pca, data = all_df, 
                       colour = "species",
                       #shape = "species",
                       #shape = "fpco2",
                       #fill = "species",               
                       frame = TRUE, 
                       frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                       frame.level = 0.95, # using 95% CI for all ellipses
                       frame.alpha = 0.01,
                       loadings = TRUE, 
                       loadings.colour = "black", 
                       loadings.label = TRUE,
                       loadings.label.colour = "black",         
                       loadings.label.size = 4, 
                       loadings.label.hjust = 1.5, 
                       loadings.label.vjust = 0.5,
                       loadings.label.repel = TRUE) +
  scale_colour_manual("", labels = c("S. siderea", "P. strigosa", "P. astreoides"), values = c("#867796", "#73CCD2", "#D2D69B")) +
  guides(shape = FALSE, fill = FALSE, color = guide_legend(keyheight = 0.1, nrow = 3, byrow = TRUE, override.aes = list(linetype = c(0, 0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA), legend.position = c(0.14, 0.9), legend.text = element_text(face = "italic")) +
  #ggsave("Figures/Final_Figures/FigureX_SpeciesPCA.pdf", width = 6, height = 4.5) +
  #ggsave("Figures/Final_Figures/FigureX_SpeciesPCA.png", width = 6, height = 4.5) +
  annotate("text", x = -0.2, y = -0.108, label = deparse(all_species_pval), parse = TRUE, size = 3)

# temperature
all_temp_pca <- autoplot(all_pca, data = all_df, 
                       colour = "ftemp",
                       #shape = "fpco2",
                       shape = "ftemp",
                       fill = "ftemp",               
                       frame = TRUE, 
                       frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                       frame.level = 0.95, # using 95% CI for all ellipses
                       frame.alpha = 0.01,
                       loadings = TRUE, 
                       loadings.colour = "black", 
                       loadings.label = TRUE,
                       loadings.label.colour = "black",         
                       loadings.label.size = 4, 
                       loadings.label.hjust = 1.5, 
                       loadings.label.vjust = 0.5,
                       loadings.label.repel = TRUE) +
  scale_shape_manual("temperature", labels = c("28C", "31C"), values = c(21, 21)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", "#b2182b"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", NA))+
  guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.position = c(0.09, 0.9), legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.21, y = -0.118, label = deparse(all_temp_pval), parse = TRUE, size = 3) +
  annotate("text", x = -0.18, y = -0.14, label = deparse(all_s_temp_pval), parse = TRUE, size = 3)

# pco2
all_pco2_pca <- autoplot(all_pca, data = all_df, 
                       colour = "fpco2",
                       #shape = "ftemp",
                       fill = "fpco2",
                       shape = "fpco2",
                       frame = TRUE, 
                       frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                       frame.level = 0.95, # using 95% CI for all ellipses
                       frame.alpha = 0.01,
                       loadings = TRUE, 
                       loadings.colour = "black", 
                       loadings.label = TRUE,
                       loadings.label.colour = "black",         
                       loadings.label.size = 4, 
                       loadings.label.hjust = 1.5, 
                       loadings.label.vjust = 0.5,
                       loadings.label.repel = TRUE) +
  scale_shape_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
  scale_fill_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  scale_colour_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  guides(color = guide_legend(nrow = 4, override.aes = list(linetype = c(0, 0, 0, 0)))) +
  annotate("text", x = -0.20, y = -0.118, label = deparse(all_pco2_pval), parse = TRUE, size = 3) +
  annotate("text", x = -0.18, y = -0.14, label = deparse(all_s_pco2_pval), parse = TRUE, size = 3) +
  theme(legend.position = c(0.16, 0.9), legend.background = element_rect(fill = "transparent", colour = NA))

```

```{r species PCA plot, fig.width = 15, fig.height = 4.7}

ggarrange(species_pca_plot, all_pco2_pca, all_temp_pca, nrow =1, labels = "AUTO") +
  ggsave("Figures/Final_Figures/Figure4_PhysPCA.pdf", width = 15, height = 4.7) +
  ggsave("Figures/Final_Figures/Figure4_PhysPCA.png", width = 15, height = 4.7)

```

**Figure 4.** Principal component analysis (PCA) comparing the coral holobiont of all three species at the end of the experiment depicted by (**A**) species, (**B**) *p*CO~2~ treatment, and (**C**) temperature treatment. Arrows represent significant (p < 0.05) correlation vectors for physiological parameters and ellipses represent 95% confidence based on multivariate t-distributions.

<br/>
<br/>


## Correlation assessments {.tabset}

#### *Methods:*
Correlations of all physiological parameters were assessed to determine the relationships between parameters within each species, redargless of temperature and *p*CO~2~ treatment. The Pearson correlation coefficient (R^2^) of each comparison was calculated using the corrgram package (version `r packageVersion("corrgram")`) and the significance was calculated using the *cor.test* function. These relationships were then visualized through simple scatterplots.

<br/>

#### *Results:*
Correlations of coral holobiont physiological parameters were generally positively related with one another across all three species. Correlations between *S. siderea* holobiont physiological parameters identified 15 significant relationships out of all 21 possible comparisons (**Figure 2A**). Of those significant correlations, six resulted in a Pearson's correlation coefficient (R^2^) equal to or greater than 0.5, with the strongest relationship identified being symbiont density vs chlorophyll a (R^2^ = 0.72). All pairwise physiological parameters were significantly correlated with one another in *P. strigosa* and of those, 14 correlations exhibit moderate (R^2^ > 0.50) positive relationships (**Figure 2B**). Notably, the two strongest correlations were host carbohydrate vs host protein (R^2^ = 0.70) and host carbohydrate vs chlorophyll a (R^2^ = 0.76). Compared to both *S. siderea* and *P. strigosa*, fewer physiological traits were significantly (p < 0.05) correlated with one another in *P. astreoides* (12 significant out of 21 total comparisons; **Figure 2C**). Of the significant correlations, only two pairwise comparisons resulted in a Pearson's correlation coefficient greater than 0.5: chlorophyll a vs colour intensity (R^2^ = 0.57) and host carbohydrate vs host protein (R^2^ = 0.68).

<br/>

```{r SSID correlation matrix and scatter plots, results='hide'}

## Create new correlation dataframe for SSID
sid_corr_df <- s_df[,c(10:11,14:17,21:23)] %>% 
  mutate(shape = case_when(ftemp == "28" ~ "19",
                           ftemp == "31" ~ "21"),
         colour = case_when(fpco2 == "300" ~ "#b2abd2",
                            fpco2 == "420" ~ "#5e3c99",
                            fpco2 == "680" ~ "#fdb863",
                            fpco2 == "3300" ~ "#e66101"))

## Plot correlation matrix and scatter plot of all SSID physiology  
png(file = "Figures/Supplemental_Figures/SSID_PhysCorrelations.png", width = 240.57, height = 164.025, units='mm', res = 300)  

corrgram(sid_corr_df, order = FALSE, lower.panel = panel.fill.R2, upper.panel = panel.pts.col, text.panel = panel.txt.brdr,
         col.regions = colorRampPalette(c("#ffffcc", "#c7e9b4", "#225ea8")), 
         color = sid_corr_df$colour, pch = as.numeric(as.character(sid_corr_df$shape)),
         labels = c("symbiont \ndensity", "host \nprotein", "chlorophyll a", "colour \nintensity", "calcification \nrate", "host \ncarbohydrate", "host \nlipid")) 

dev.off() 

```

```{r PSTR correlation matrix and scatter plots, results='hide'}

## Create new correlation dataframe for SSID
dip_corr_df <- p_df[,c(10:11,14:17,21:23)] %>% 
  mutate(shape = case_when(ftemp == "28" ~ "19",
                           ftemp == "31" ~ "21"),
         colour = case_when(fpco2 == "300" ~ "#b2abd2",
                            fpco2 == "420" ~ "#5e3c99",
                            fpco2 == "680" ~ "#fdb863",
                            fpco2 == "3300" ~ "#e66101"))
  

## Plot correlation matrix and scatter plot of all PSTR physiology
png(file = "Figures/Supplemental_Figures/PSTR_PhysCorrelations.png", width = 240.57, height = 164.025, units='mm', res = 300) 

corrgram(dip_corr_df, order = FALSE, lower.panel=panel.fill.R2, upper.panel=panel.pts.col, text.panel=panel.txt.brdr,
         col.regions=colorRampPalette(c("#ffffcc", "#c7e9b4", "#225ea8")), 
         color = dip_corr_df$colour, pch = as.numeric(as.character(dip_corr_df$shape)),
         labels = c("symbiont \ndensity", "host \nprotein", "chlorophyll a", "colour \nintensity", "calcification \nrate", "host \ncarbohydrate", "host \nlipid")) 

dev.off() 

```

```{r PAST correlation matrix and scatter plots, results='hide'}

## Create new correlation dataframe for SSID
por_corr_df <- a_df[,c(10:11,14:16,18,21:23)] %>% 
  mutate(shape = case_when(ftemp == "28" ~ "19",
                           ftemp == "31" ~ "21"),
         colour = case_when(fpco2 == "300" ~ "#b2abd2",
                            fpco2 == "420" ~ "#5e3c99",
                            fpco2 == "680" ~ "#fdb863",
                            fpco2 == "3300" ~ "#e66101"))
  

## Plot correlation matrix and scatter plot of all PAST physiology
png(file = "Figures/Supplemental_Figures/PAST_PhysCorrelations.png", width = 240.57, height = 164.025, units='mm', res = 300) 

corrgram(por_corr_df, order = FALSE, lower.panel=panel.fill.R2, upper.panel=panel.pts.col, text.panel=panel.txt.brdr,
         col.regions=colorRampPalette(c("#ffffcc", "#c7e9b4", "#225ea8")), 
         color = por_corr_df$colour, pch = as.numeric(as.character(por_corr_df$shape)),
         labels = c("symbiont \ndensity", "host \nprotein", "chlorophyll a", "colour \nintensity", "calcification \nrate", "host \ncarbohydrate", "host \nlipid")) 

dev.off() 

```


### *Figure 2*

```{r save all species correlation/scatter plots, fig.width = 8, fig.height = 6.4}

ssid_corr_plot <- readPNG("Figures/Supplemental_Figures/SSID_PhysCorrelations.png")
pstr_corr_plot <- readPNG("Figures/Supplemental_Figures/PSTR_PhysCorrelations.png")
past_corr_plot <- readPNG("Figures/Supplemental_Figures/PAST_PhysCorrelations.png")

ssid_corr_plot <- ggplot() + 
  background_image(ssid_corr_plot) + 
  theme_void() + 
  ggtitle(expression(paste(bold("  A)   "), italic("S. siderea"))))

pstr_corr_plot <- ggplot() + 
  background_image(pstr_corr_plot) + 
  theme_void() + 
  ggtitle(expression(paste(bold("  B)   "), italic("P. strigosa"))))

past_corr_plot <- ggplot() + 
  background_image(past_corr_plot) + 
  theme_void() + 
  ggtitle(expression(paste(bold("  C)   "), italic("P. asteroides"))))

ggarrange(ssid_corr_plot, pstr_corr_plot, past_corr_plot, nrows = 2) +
  ggsave("Figures/Final_Figures/Figure2_PhysCorrelations.pdf", width = 8, height = 6.4) +
  ggsave("Figures/Final_Figures/Figure2_PhysCorrelations.png", width = 8, height = 6.4)

```

**Figure 2.** Coral holobiont correlation matrices (bottom panel) and scatter plots (top panel) for (**A**) *S. siderea*, (**B**) *P. strigosa*, and (**C**) *P. astreoides* depicting pairwise comparisons of physiological parameters within each species. Strength of correlations between parameters is indicated by darker shades of blue in the bottom panel with a higher R^2^ value (Pearson correlation coefficient). Of these correlations, significant correlations are depicted with asterisks according to significance level (\* p < 0.05; \*\* p < 0.01; \*\*\* p < 0.001). Scatter plots of physiological parameters are displayed in the top panel with temperature depicted by shape (28$^\circ$C filled points; 31$^\circ$C open points) and *p*CO~2~ depicted by colour (280 $\mu$atm light purple; 400 $\mu$atm dark purple; 700 $\mu$atm light orange; 2800 $\mu$atm dark orange).

<br/>
<br/>


## Plasticity analyses {.tabset} 

#### *Methods:*
Using PC1 and PC2 for each species, we then calculated the physiological plasticity of each experimental fragment. Plasticity was calculated as the PC distance between an experimental fragment and the control (400 $\mu$atm; 28$^\circ$C) fragment from that same colony. The effects of treatment (*p*CO~2~ and temperature) and natal reef environment on calculated distances were assessed using generalized linear models (function *glm*) with a Gamma distribution and log-link. The best-fit model was selected as the model with the lowest AIC for each species (**Table S1**). The main effects of treatment and reef environment were assessed with an ANOVA (package *car*; version `r packageVersion("car")`) with a type III error. All figures and statistical analyses were carried out in `r paste0("R version ", R.Version()$major, ".", R.Version()$minor)` (R Core Development Team 2016).

<br/>

#### *Results:*
Natal reef environment (p < 0.05) and *p*CO~2~ (p < 0.05) significantly altered the physiological plasticity of *S. siderea* (**Figure 3A; Table S3, S4**). Offshore fragments exhibited a positive linear trend with increasing *p*CO~2~ while the inshore fragments appear to respond in a parabolic pattern to *p*CO~2~, with the lowest calculated distances occurring at 400 $\mu$atm, 31$^\circ$C and 700 $\mu$atm, 28$^\circ$C. Plasticity of *P. strigosa* and *P. astreoides* was not significantly altered by temperature treatment, *p*CO~2~ treatment, or natal reef environment (**Figure 3B, 3C; Table S3, S4**). However, *P. astreoides* exhibited a slight trend in the inshore fragments suggesting potentially higher plasticity with increasing *p*CO~2~ that is not seen in the offshore fragments (**Figure 3C**).

<br/>

### *Siderastrea siderea*

```{r SSID distance analysis, include=FALSE}

## Calculate the PCA distance with custom function
sid_dist <- PCAplast(pca = s_pca,
                     data = s_df[,c(1,7,8, 10,11,12,27)],
                     control_col = "treat2",
                     control_lvl = "447_28")

sid_dist_sum <- DistSum(data = sid_dist)


## Model selection (via AIC) -- check AICc --> try a mixed glm gamma
## using mixed model, could look at differences by colony
# with strong random effects of colony??
# marginal R2 --> fixed v random effect variance: likely more variance at colony level over treatment
# bootstrap final model for CI/predictions
ssid_dist_mod <- glmer(dist ~ reef * fpco2 * ftemp + (1 | colony), family = Gamma(link = "log"), data = sid_dist)
ssid_dist_mod2 <- glmer(dist ~ reef * fpco2 + ftemp + (1 | colony), family = Gamma(link = "log"), data = sid_dist) # best fit
ssid_dist_mod3 <- glmer(dist ~ reef + fpco2 * ftemp + (1 | colony), family = Gamma(link = "log"), data = sid_dist)
ssid_dist_mod4 <- glmer(dist ~ reef + fpco2 + ftemp + (1 | colony), family = Gamma(link = "log"), data = sid_dist)
ssid_dist_mod5 <- glmer(dist ~ reef * (fpco2 + ftemp) + (1 | colony), family = Gamma(link = "log"), data = sid_dist)
ssid_dist_mod6 <- glmer(dist ~ fpco2 + ftemp + (1 | colony), family = Gamma(link = "log"), data = sid_dist)

# check for best-fit model
ssid_plast_aic <- compare_performance(ssid_dist_mod, ssid_dist_mod2, ssid_dist_mod3, ssid_dist_mod4, ssid_dist_mod5, ssid_dist_mod6, rank = TRUE)
plot(ssid_plast_aic)


## Best-fit GLM with Gamma log link
ssid_dist_glm <- glmer(dist ~ reef * fpco2 + ftemp + (1 | colony), family = Gamma(link = "log"), data = sid_dist)
ssid_glm_out <- summary(ssid_dist_glm) # summary output of the GLM
library(rcompanion)
r2_nakagawa(ssid_dist_glm)
#  Conditional R2: 0.506 -- fixed and random effects
#     Marginal R2: 0.322 -- fixed effects only




#### Need to be consistent with pCO2 number references:
# 280 --> 300 uatm = pre-industrial
# 400 --> 420 uatm = current day
# 700 --> 680 uatm = end of century
# 2800 --> 3290 uatm = extreme

## check the symbiont bar plot

#ssid_dist_boot_df1500 <- ssid_dist_boot_df

## parametric bootstrap:
ssid_dist_boot <- bootMer(ssid_dist_glm, function(x) predict(x, type = "response"), nsim = 100)
ssid_dist_boot_df <- data.frame(estimate = ssid_dist_boot$t0,
                                t(apply(ssid_dist_boot$t, 2, function(x) quantile(x, probs = c(0.025, .975)))),
                                ssid_dist_boot[["data"]],
                                treat = paste(ssid_dist_boot[["data"]][["fpco2"]], ssid_dist_boot[["data"]][["ftemp"]], sep = "_"))

ggplot(data = ssid_dist_boot_df, aes(x = treat, colour = reef)) +
  theme_bw() +
  geom_point(aes(y = dist, group = reef), size = 2, alpha = 0.4, position = position_dodge(width = 0.1)) +
  geom_linerange(aes(ymin = X2.5., ymax = X97.5.), position = position_dodge(width = 0.4)) +
  geom_point(aes(y = estimate), size = 2, position = position_dodge(width = 0.4)) +
  #ylim(0, 20) +
  ggtitle("nsim = 1500")




ssid_dist_boot <- bootMer(ssid_dist_glm, fixef, nsim = 50)

ssid_dist_boot_df <- data.frame(estimate = ssid_dist_boot$t0,
                                t(apply(ssid_dist_boot$t, 2, function(x) quantile(x, probs = c(0.025, .975)))))
                                #ssid_dist_boot[["data"]],
                                #treat = paste(ssid_dist_boot[["data"]][["fpco2"]], ssid_dist_boot[["data"]][["ftemp"]], sep = "_"))

ggplot(data = ssid_dist_boot_df, aes(x = rownames(ssid_dist_boot_df))) +
  theme_bw() +
  geom_linerange(aes(ymin = X2.5., ymax = X97.5.), position = position_dodge(width = 0.4)) +
  geom_point(aes(y = estimate), size = 2, position = position_dodge(width = 0.4)) +
  #ylim(0, 20) +
  ggtitle("nsim = 1500")


```

```{r plots of SSID distances, fig.height = 3.5, fig.width = 6}

## Plasticity plot
ssid_plast_plot <- ggplot(sid_dist_sum, aes(x = reef, y = mean, colour = treat2, fill = treat2, shape = treat2)) +
  theme_pubr() +
  theme(legend.title = element_blank(), axis.ticks.x = element_blank()) +
  guides(shape = guide_legend(ncol = 1), fill = guide_legend(override.aes = list(linetype = 0)), color = guide_legend(override.aes = list(linetype = 0))) +
  geom_point(data = sid_dist, aes(x = reef, y = dist), size = 2, alpha = 0.7, position = position_dodge(width = 0.55)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), alpha = 0.8, size = 1, width = 0, position = position_dodge(width = 0.55)) +
  geom_point(size = 3, stroke = 1, position = position_dodge(width = 0.55)) +
  scale_shape_manual(values = c(21, 21, 23, 24, 24, 22, 22)) +
  scale_colour_manual(values = c("#b2abd2", "#b2abd2", "#5e3c99", "#fdb863", "#fdb863", "#e66101", "#e66101")) + 
  scale_fill_manual(values = c("#b2abd2", "white", "white", "#fdb863", "white", "#e66101", "white")) + 
  labs(y = "PC distance from control", x = "") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 8)) +
  scale_x_discrete(labels = c("F" = "Offshore", "N" = "Inshore")) +
  ggtitle(expression(paste(bold("A)   "), italic("S. siderea"))))
  

## Model output
ssid_glm_out # summary output of the GLM

```

<br/>
<br/>


### *Pseudodiploria strigosa*

```{r PSTR distance analysis, include=FALSE}

## Calculate the PCA distance with custom function
dip_dist <- PCAplast(pca = p_pca, data = p_df)
dip_dist_sum <- DistSum(data = dip_dist)


## Model selection (via AIC)
pstr_dist_mod <- glm(dist ~ reef * fpco2 * ftemp, family = Gamma(link = "log"), data = dip_dist)
pstr_dist_mod2 <- glm(dist ~ reef * fpco2 + ftemp, family = Gamma(link = "log"), data = dip_dist)
pstr_dist_mod3 <- glm(dist ~ reef + fpco2 * ftemp, family = Gamma(link = "log"), data = dip_dist) # best fit but results in singularity for 400_31 so moving forward with mod4
pstr_dist_mod4 <- glm(dist ~ reef + fpco2 + ftemp, family = Gamma(link = "log"), data = dip_dist) # using this model
pstr_dist_mod5 <- glm(dist ~ reef * (fpco2 + ftemp), family = Gamma(link = "log"), data = dip_dist)
pstr_dist_mod6 <- glm(dist ~ fpco2 + ftemp, family = Gamma(link = "log"), data = dip_dist)

# check for best-fit model
pstr_plast_aic <- compare_performance(pstr_dist_mod, pstr_dist_mod2, pstr_dist_mod3, pstr_dist_mod4, pstr_dist_mod5, pstr_dist_mod6, rank = TRUE)
plot(pstr_plast_aic)


## Best-fit GLM with Gamma log link
pstr_dist_glm <- glm(dist ~ reef + fpco2 + ftemp, family = Gamma(link = "log"), data = dip_dist, contrasts = list(reef=contr.sum, fpco2=contr.sum, ftemp=contr.sum))
pstr_glm_out <- summary(pstr_dist_glm) # summary output of the GLM
pstr_anova_out <- Anova(pstr_dist_glm, type = "III", test.statistic = "F") # comparison of the 'main effects'

```
  
```{r plots of PSTR distances, fig.height = 3.5, fig.width = 6}

## Plasticity plot
pstr_plast_plot <- ggplot(dip_dist_sum, aes(x = reef, y = mean, colour = treat_plot, fill = treat_plot, shape = treat_plot)) +
  theme_pubr() +
  theme(legend.title = element_blank(), axis.ticks.x = element_blank()) +
  guides(shape = guide_legend(ncol = 1), fill = guide_legend(override.aes = list(linetype = 0)), color = guide_legend(override.aes = list(linetype = 0))) +
  geom_point(data = dip_dist, aes(x = reef, y = dist), size = 2, alpha = 0.7, position = position_dodge(width = 0.55)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), alpha = 0.8, size = 1, width = 0, position = position_dodge(width = 0.55)) +
  geom_point(size = 3, stroke = 1, position = position_dodge(width = 0.55)) +
  scale_shape_manual(values = c(21, 21, 23, 24, 24, 22, 22)) +
  scale_colour_manual(values = c("#b2abd2", "#b2abd2", "#5e3c99", "#fdb863", "#fdb863", "#e66101", "#e66101")) + 
  scale_fill_manual(values = c("#b2abd2", "white", "white", "#fdb863", "white", "#e66101", "white")) + 
  labs(y = "", x = "") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 8)) +
  scale_x_discrete(labels = c("F" = "Offshore", "N" = "Inshore")) +
  ggtitle(expression(paste(bold("B)   "), italic("P. strigosa"))))


## Model output
pstr_glm_out # summary output of the GLM
pstr_anova_out # comparison of the 'main effects'

```

<br/>
<br/>


### *Porites astreoides*

```{r PAST distance analysis, include=FALSE}

## Calculate the PCA distance with custom function
por_dist <- PCAplast(pca = a_pca, data = a_df)
por_dist_sum <- DistSum(data = por_dist)


## Model selection (via AIC)
past_dist_mod <- glm(dist ~ reef * fpco2 * ftemp, family = Gamma(link = "log"), data = por_dist)
past_dist_mod2 <- glm(dist ~ reef * fpco2 + ftemp, family = Gamma(link = "log"), data = por_dist)
past_dist_mod3 <- glm(dist ~ reef + fpco2 * ftemp, family = Gamma(link = "log"), data = por_dist)
past_dist_mod4 <- glm(dist ~ reef + fpco2 + ftemp, family = Gamma(link = "log"), data = por_dist) # using this model
past_dist_mod5 <- glm(dist ~ reef * (fpco2 + ftemp), family = Gamma(link = "log"), data = por_dist)
past_dist_mod6 <- glm(dist ~ fpco2 + ftemp, family = Gamma(link = "log"), data = por_dist) # best fit but using mod4 to include reef

# check for best-fit model
past_plast_aic <- compare_performance(past_dist_mod, past_dist_mod2, past_dist_mod3, past_dist_mod4, past_dist_mod5, past_dist_mod6, rank = TRUE)
plot(past_plast_aic)


## Best-fit GLM with Gamma log link
past_dist_glm <- glm(dist ~ reef + fpco2 + ftemp, family = Gamma(link = "log"), data = por_dist, contrasts = list(reef=contr.sum, fpco2=contr.sum, ftemp=contr.sum))
past_glm_out <- summary(past_dist_glm) # summary output of the GLM
past_anova_out <- Anova(past_dist_glm, type = "III", test.statistic = "F") # comparison of the 'main effects'

```
  
```{r plots of PAST distances, fig.height = 3, fig.width = 10}

## Plasticity plot
past_plast_plot <- ggplot(por_dist_sum, aes(x = reef, y = mean, colour = treat_plot, fill = treat_plot, shape = treat_plot)) +
  theme_pubr() +
  theme(legend.title = element_blank(), axis.ticks.x = element_blank()) +
  guides(shape = guide_legend(ncol = 1), fill = guide_legend(override.aes = list(linetype = 0)), color = guide_legend(override.aes = list(linetype = 0))) +
  geom_point(data = por_dist, aes(x = reef, y = dist), size = 2, alpha = 0.7, position = position_dodge(width = 0.55)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), alpha = 0.8, size = 1, width = 0, position = position_dodge(width = 0.55)) +
  geom_point(size = 3, stroke = 1, position = position_dodge(width = 0.55)) +
  scale_shape_manual(values = c(21, 21, 23, 24, 24, 22, 22)) +
  scale_colour_manual(values = c("#b2abd2", "#b2abd2", "#5e3c99", "#fdb863", "#fdb863", "#e66101", "#e66101")) + 
  scale_fill_manual(values = c("#b2abd2", "white", "white", "#fdb863", "white", "#e66101", "white")) + 
  labs(y = "", x = "") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 8)) +
  scale_x_discrete(labels = c("F" = "Offshore", "N" = "Inshore")) +
  ggtitle(expression(paste(bold("C)   "), italic("P. astreoides"))))


## Model output
past_glm_out # summary output of the GLM
past_anova_out # comparison of the 'main effects'

```

<br/>
<br/>


### **Figure 3**

```{r plot and save all species plasticity, fig.width = 13, fig.height = 4}

ggarrange(ssid_plast_plot, pstr_plast_plot, past_plast_plot, common.legend = TRUE, legend = "right", ncol = 3) +
  ggsave("Figures/Final_Figures/Figure3_PhysPlasticity.pdf", width = 13, height = 4) +
  ggsave("Figures/Final_Figures/Figure3_PhysPlasticity.png", width = 13, height = 4)

```

**Figure 3.** Assessment of physiological plasticity of (**A**) *S. siderea*, (**B**) *P. strigosa*, and (**C**) *P. astreoides* in experimental treatments and by natal reef environment. Higher values represent greater plasticity in coral holobiont samples. *p*CO~2~ treatment is depicted by colour and shape (280 $\mu$atm light purple, circle; 400 $\mu$atm dark purple, diamond; 700 $\mu$atm light orange, triangle; 2800 $\mu$atm dark orange, square) and temperature is represented as either filled (28$^\circ$C) or open (31$^\circ$C) symbols.

<br/>
<br/>


## Supplemental Figures{.tabset}

### Figure S1

```{r PCA plot reefs, fig.height = 3.8, fig.width = 13}

ggarrange(s_reef_pca, p_reef_pca, a_reef_pca, ncol = 3, common.legend = TRUE, legend = "right") +
  ggsave("Figures/Supplemental_Figures/FigureS1_PhysPCA_RZ.pdf", width = 13, height = 3.8) +
  ggsave("Figures/Supplemental_Figures/FigureS1_PhysPCA_RZ.png", width = 13, height = 3.8)

```

**Figure S1.** Principal component analysis (PCA) of all coral holobiont physiological parameters for (**A**) *S. siderea*, (**B**) *P. strigosa*, and (**C**) *P. astreoides* depicted by natal reef environment (offshore green; inshore yellow). Arrows represent significant (p < 0.05) correlation vectors for physiological parameters and ellipses represent 95% confidence based on multivariate t-distributions.

<br/>
<br/>


### Figure S2

```{r SSID PCAs by host versus symbiont}

## subset for host or symbiont physiology
sid_pca_df_host <- s_df[,c(15,22:23)] # host only phys (lipid, protein, carb)
sid_pca_df_symb <- s_df[,c(14,16,17)] # symbiont only phys (chla, density, colour intensity)


## run the adonis for HOST phys
#s_pca_host_mod <- adonis2(sid_pca_df_host ~ reef * ftemp * fpco2, data = s_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
s_pca_host_mod <- adonis2(sid_pca_df_host ~ fpco2 + ftemp + reef, data = s_df, method = 'eu', permutations = bootnum)
s_pca_host_mod # view SSID adonis output

## run the adonis for SYMB phys
#s_pca_symb_mod <- adonis2(sid_pca_df_symb ~ reef * ftemp * fpco2, data = s_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
s_pca_symb_mod <- adonis2(sid_pca_df_symb ~ fpco2 + ftemp + reef, data = s_df, method = 'eu', permutations = bootnum)
s_pca_symb_mod # view SSID adonis output


## perform principal component analysis (PCA)
s_pca_host <- prcomp(sid_pca_df_host, center = TRUE, scale= TRUE)
s_pca_symb <- prcomp(sid_pca_df_symb, center = TRUE, scale= TRUE)

```

```{r Plot SSID PCAs by host versus symbiont}

## Temperature PCAs
# HOST temperature
sid_host_temp_pca <- autoplot(s_pca_host, data = s_df, 
         colour = "ftemp",
         #shape = "fpco2",
         shape = "ftemp",
         fill = "ftemp",               
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 1.5, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  scale_shape_manual("temperature", labels = c("28C", "31C"), values = c(21, 21)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", "#b2182b"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", NA))+
  guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  ggtitle("SSID Host")


# SYMB temperature
sid_symb_temp_pca <- autoplot(s_pca_symb, data = s_df, 
         colour = "ftemp",
         #shape = "fpco2",
         shape = "ftemp",
         fill = "ftemp",               
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 1.5, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  scale_shape_manual("temperature", labels = c("28C", "31C"), values = c(21, 21)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", "#b2182b"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", NA))+
  guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  ggtitle("SSID Symbionts")



## pCO2 PCAs
# HOST pco2
sid_host_pco2_pca <- autoplot(s_pca_host, data = s_df, 
                          colour = "fpco2",
                          #shape = "ftemp",
                          fill = "fpco2",
                          shape = "fpco2",
                          frame = TRUE, 
                          frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                          frame.level = 0.95, # using 95% CI for all ellipses
                          frame.alpha = 0.01,
                          loadings = TRUE, 
                          loadings.colour = "black", 
                          loadings.label = TRUE,
                          loadings.label.colour = "black",         
                          loadings.label.size = 4, 
                          loadings.label.hjust = 1.5, 
                          loadings.label.vjust = 0.5,
                          loadings.label.repel = TRUE) +
  scale_shape_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
  scale_fill_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  scale_colour_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  guides(color = guide_legend(nrow = 4, override.aes = list(linetype = c(0, 0, 0, 0)))) +
  theme(legend.background = element_rect(fill = "transparent", colour = NA))


# SYMB pco2
sid_symb_pco2_pca <- autoplot(s_pca_symb, data = s_df, 
                          colour = "fpco2",
                          #shape = "ftemp",
                          fill = "fpco2",
                          shape = "fpco2",
                          frame = TRUE, 
                          frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                          frame.level = 0.95, # using 95% CI for all ellipses
                          frame.alpha = 0.01,
                          loadings = TRUE, 
                          loadings.colour = "black", 
                          loadings.label = TRUE,
                          loadings.label.colour = "black",         
                          loadings.label.size = 4, 
                          loadings.label.hjust = 1.5, 
                          loadings.label.vjust = 0.5,
                          loadings.label.repel = TRUE) +
  scale_shape_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
  scale_fill_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  scale_colour_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  guides(color = guide_legend(nrow = 4, override.aes = list(linetype = c(0, 0, 0, 0)))) +
  theme(legend.background = element_rect(fill = "transparent", colour = NA))



## Reef PCAs
# HOST reef
sid_host_reef_pca <- autoplot(s_pca_host, data = s_df,  
                          colour = "reef",
                          fill = "reef",
                          frame = TRUE, 
                          frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                          frame.level = 0.95, # using 95% CI for all ellipses
                          frame.alpha = 0.01,
                          loadings = TRUE, 
                          loadings.colour = "black", 
                          loadings.label = TRUE,
                          loadings.label.colour = "black",         
                          loadings.label.size = 4, 
                          loadings.label.hjust = -0.6, 
                          loadings.label.vjust = 0.5,
                          loadings.label.repel = TRUE) +
  scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  scale_fill_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  guides(fill = FALSE, color = guide_legend(keyheight = 0.3, nrow = 2, override.aes = list(linetype = c(0, 0))), shape = guide_legend(nrow = 2, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.3, y = -0.38, label = deparse(s_reef_pval), parse = TRUE, size = 3)


# SYMB reef
sid_symb_reef_pca <- autoplot(s_pca_symb, data = s_df,  
                          colour = "reef",
                          fill = "reef",
                          frame = TRUE, 
                          frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                          frame.level = 0.95, # using 95% CI for all ellipses
                          frame.alpha = 0.01,
                          loadings = TRUE, 
                          loadings.colour = "black", 
                          loadings.label = TRUE,
                          loadings.label.colour = "black",         
                          loadings.label.size = 4, 
                          loadings.label.hjust = -0.6, 
                          loadings.label.vjust = 0.5,
                          loadings.label.repel = TRUE) +
  scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  scale_fill_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  guides(fill = FALSE, color = guide_legend(keyheight = 0.3, nrow = 2, override.aes = list(linetype = c(0, 0))), shape = guide_legend(nrow = 2, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.3, y = -0.38, label = deparse(s_reef_pval), parse = TRUE, size = 3)

```

```{r combined SSID host v symb PCA plot, fig.width = 9, fig.height = 10}

## Combine PCAs by treatment for common legend:
ssid_host_symb_temp <- ggarrange(sid_host_temp_pca, sid_symb_temp_pca,ncol = 2, common.legend = TRUE, legend = "right")  # temperature
ssid_host_symb_pco2 <- ggarrange(sid_host_pco2_pca, sid_symb_pco2_pca,ncol = 2, common.legend = TRUE, legend = "right")  # pCO2
ssid_host_symb_reef <- ggarrange(sid_host_reef_pca, sid_symb_reef_pca,ncol = 2, common.legend = TRUE, legend = "right")  # reef

## Add all together for final figure:
ggarrange(ssid_host_symb_temp, ssid_host_symb_pco2, ssid_host_symb_reef, nrow = 3) +
  ggsave("Figures/Supplemental_Figures/FigureS2_SSID_PCA_hostVsymb.pdf", width = 9, height = 10) +
  ggsave("Figures/Supplemental_Figures/FigureS2_SSID_PCA_hostVsymb.png", width = 9, height = 10)


```

**Figure S2.** Principal component analysis (PCA) of *S. siderea* coral host (protein, lipid, carbohydrate; left) or algal symbiont (chlorophyll a, symbiont density, colour intensity; right) physiological parameters by temperature (28 Â°C blue; 31 Â°C red), pCO2 (280 Î¼atm light purple; 400 Î¼atm dark purple; 700 Î¼atm light orange; 2800 Î¼atm dark orange), and natal reef environment (offshore green; inshore yellow). Arrows represent significant (p < 0.05) correlation vectors for physiological parameters and ellipses represent 95% confidence based on multivariate t-distributions.

<br/>
<br/>


### Figure S3

```{r PSTR PCAs by host versus symbiont}

## subset for host or symbiont physiology
dip_pca_df_host <- p_df[,c(15,22:23)] # host only phys (lipid, protein, carb)
dip_pca_df_symb <- p_df[,c(14,16,17)] # symbiont only phys (chla, density, colour intensity)


## run the adonis for HOST phys
#s_pca_host_mod <- adonis2(dip_pca_df_host ~ reef * ftemp * fpco2, data = p_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
p_pca_host_mod <- adonis2(dip_pca_df_host ~ fpco2 + ftemp + reef, data = p_df, method = 'eu', permutations = bootnum)
p_pca_host_mod # view PSTR adonis output

## run the adonis for SYMB phys
#s_pca_symb_mod <- adonis2(dip_pca_df_symb ~ reef * ftemp * fpco2, data = p_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
p_pca_symb_mod <- adonis2(dip_pca_df_symb ~ fpco2 + ftemp + reef, data = p_df, method = 'eu', permutations = bootnum)
p_pca_symb_mod # view PSTR adonis output


## perform principal component analysis (PCA)
p_pca_host <- prcomp(dip_pca_df_host, center = TRUE, scale= TRUE)
p_pca_symb <- prcomp(dip_pca_df_symb, center = TRUE, scale= TRUE)

```

```{r Plot PSTR PCAs by host versus symbiont}

## Temperature PCAs
# HOST temperature
dip_host_temp_pca <- autoplot(p_pca_host, data = p_df, 
                              colour = "ftemp",
                              #shape = "fpco2",
                              shape = "ftemp",
                              fill = "ftemp",               
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = 1.5, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_shape_manual("temperature", labels = c("28C", "31C"), values = c(21, 21)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", "#b2182b"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", NA))+
  guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  ggtitle("PSTR Host")


# SYMB temperature
dip_symb_temp_pca <- autoplot(p_pca_symb, data = p_df, 
                              colour = "ftemp",
                              #shape = "fpco2",
                              shape = "ftemp",
                              fill = "ftemp",               
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = 1.5, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_shape_manual("temperature", labels = c("28C", "31C"), values = c(21, 21)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", "#b2182b"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", NA))+
  guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  ggtitle("PSTR Symbionts")



## pCO2 PCAs
# HOST pco2
dip_host_pco2_pca <- autoplot(p_pca_host, data = p_df, 
                              colour = "fpco2",
                              #shape = "ftemp",
                              fill = "fpco2",
                              shape = "fpco2",
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = 1.5, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_shape_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
  scale_fill_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  scale_colour_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  guides(color = guide_legend(nrow = 4, override.aes = list(linetype = c(0, 0, 0, 0)))) +
  theme(legend.background = element_rect(fill = "transparent", colour = NA))


# SYMB pco2
dip_symb_pco2_pca <- autoplot(p_pca_symb, data = p_df, 
                              colour = "fpco2",
                              #shape = "ftemp",
                              fill = "fpco2",
                              shape = "fpco2",
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = 1.5, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_shape_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
  scale_fill_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  scale_colour_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  guides(color = guide_legend(nrow = 4, override.aes = list(linetype = c(0, 0, 0, 0)))) +
  theme(legend.background = element_rect(fill = "transparent", colour = NA))



## Reef PCAs
# HOST reef
dip_host_reef_pca <- autoplot(p_pca_host, data = p_df,  
                              colour = "reef",
                              fill = "reef",
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = -0.6, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  scale_fill_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  guides(fill = FALSE, color = guide_legend(keyheight = 0.3, nrow = 2, override.aes = list(linetype = c(0, 0))), shape = guide_legend(nrow = 2, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.3, y = -0.38, label = deparse(s_reef_pval), parse = TRUE, size = 3)


# SYMB reef
dip_symb_reef_pca <- autoplot(p_pca_symb, data = p_df,  
                              colour = "reef",
                              fill = "reef",
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = -0.6, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  scale_fill_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  guides(fill = FALSE, color = guide_legend(keyheight = 0.3, nrow = 2, override.aes = list(linetype = c(0, 0))), shape = guide_legend(nrow = 2, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.3, y = -0.38, label = deparse(s_reef_pval), parse = TRUE, size = 3)

```

```{r combined PSTR host v symb PCA plot, fig.width = 9, fig.height = 10}

## Combine PCAs by treatment for common legend:
PSTR_host_symb_temp <- ggarrange(dip_host_temp_pca, dip_symb_temp_pca,ncol = 2, common.legend = TRUE, legend = "right")  # temperature
PSTR_host_symb_pco2 <- ggarrange(dip_host_pco2_pca, dip_symb_pco2_pca,ncol = 2, common.legend = TRUE, legend = "right")  # pCO2
PSTR_host_symb_reef <- ggarrange(dip_host_reef_pca, dip_symb_reef_pca,ncol = 2, common.legend = TRUE, legend = "right")  # reef

## Add all together for final figure:
ggarrange(PSTR_host_symb_temp, PSTR_host_symb_pco2, PSTR_host_symb_reef, nrow = 3) +
  ggsave("Figures/Supplemental_Figures/FigureS3_PSTR_PCA_hostVsymb.pdf", width = 9, height = 10) +
  ggsave("Figures/Supplemental_Figures/FigureS3_PSTR_PCA_hostVsymb.png", width = 9, height = 10)


```

**Figure S3.** Principal component analysis (PCA) of P. strigosa coral host (protein, lipid, carbohydrate; left) or algal symbiont (chlorophyll a, symbiont density, colour intensity; right) physiological parameters by temperature (28 Â°C blue; 31 Â°C red), pCO2 (280 Î¼atm light purple; 400 Î¼atm dark purple; 700 Î¼atm light orange; 2800 Î¼atm dark orange), and natal reef environment (offshore green; inshore yellow). Arrows represent significant (p < 0.05) correlation vectors for physiological parameters and ellipses represent 95% confidence based on multivariate t-distributions.

<br/>
<br/>


### Figure S4

```{r PAST PCAs by host versus symbiont}

## subset for host or symbiont physiology
por_pca_df_host <- a_df[,c(15,22:23)] # host only phys (lipid, protein, carb)
por_pca_df_symb <- a_df[,c(14,16,18)] # symbiont only phys (chla, density, colour intensity)


## run the adonis for HOST phys
#s_pca_host_mod <- adonis2(por_pca_df_host ~ reef * ftemp * fpco2, data = a_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
a_pca_host_mod <- adonis2(por_pca_df_host ~ fpco2 + ftemp + reef, data = a_df, method = 'eu', permutations = bootnum)
a_pca_host_mod # view PAST adonis output

## run the adonis for SYMB phys
#s_pca_symb_mod <- adonis2(por_pca_df_symb ~ reef * ftemp * fpco2, data = a_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
a_pca_symb_mod <- adonis2(por_pca_df_symb ~ fpco2 + ftemp + reef, data = a_df, method = 'eu', permutations = bootnum)
a_pca_symb_mod # view PAST adonis output


## perform principal component analysis (PCA)
a_pca_host <- prcomp(por_pca_df_host, center = TRUE, scale= TRUE)
a_pca_symb <- prcomp(por_pca_df_symb, center = TRUE, scale= TRUE)

```

```{r Plot PAST PCAs by host versus symbiont}

## Temperature PCAs
# HOST temperature
por_host_temp_pca <- autoplot(a_pca_host, data = a_df, 
                              colour = "ftemp",
                              #shape = "fpco2",
                              shape = "ftemp",
                              fill = "ftemp",               
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = 1.5, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_shape_manual("temperature", labels = c("28C", "31C"), values = c(21, 21)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", "#b2182b"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", NA))+
  guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  ggtitle("PAST Host")


# SYMB temperature
por_symb_temp_pca <- autoplot(a_pca_symb, data = a_df, 
                              colour = "ftemp",
                              #shape = "fpco2",
                              shape = "ftemp",
                              fill = "ftemp",               
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = 1.5, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_shape_manual("temperature", labels = c("28C", "31C"), values = c(21, 21)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", "#b2182b"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#4393c3", NA))+
  guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  ggtitle("PAST Symbionts")



## pCO2 PCAs
# HOST pco2
por_host_pco2_pca <- autoplot(a_pca_host, data = a_df, 
                              colour = "fpco2",
                              #shape = "ftemp",
                              fill = "fpco2",
                              shape = "fpco2",
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = 1.5, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_shape_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
  scale_fill_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  scale_colour_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  guides(color = guide_legend(nrow = 4, override.aes = list(linetype = c(0, 0, 0, 0)))) +
  theme(legend.background = element_rect(fill = "transparent", colour = NA))


# SYMB pco2
por_symb_pco2_pca <- autoplot(a_pca_symb, data = a_df, 
                              colour = "fpco2",
                              #shape = "ftemp",
                              fill = "fpco2",
                              shape = "fpco2",
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = 1.5, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_shape_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21, 23, 24, 22)) +
  scale_fill_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  scale_colour_manual("", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
  guides(color = guide_legend(nrow = 4, override.aes = list(linetype = c(0, 0, 0, 0)))) +
  theme(legend.background = element_rect(fill = "transparent", colour = NA))



## Reef PCAs
# HOST reef
por_host_reef_pca <- autoplot(a_pca_host, data = a_df,  
                              colour = "reef",
                              fill = "reef",
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = -0.6, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  scale_fill_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  guides(fill = FALSE, color = guide_legend(keyheight = 0.3, nrow = 2, override.aes = list(linetype = c(0, 0))), shape = guide_legend(nrow = 2, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.3, y = -0.38, label = deparse(s_reef_pval), parse = TRUE, size = 3)


# SYMB reef
por_symb_reef_pca <- autoplot(a_pca_symb, data = a_df,  
                              colour = "reef",
                              fill = "reef",
                              frame = TRUE, 
                              frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                              frame.level = 0.95, # using 95% CI for all ellipses
                              frame.alpha = 0.01,
                              loadings = TRUE, 
                              loadings.colour = "black", 
                              loadings.label = TRUE,
                              loadings.label.colour = "black",         
                              loadings.label.size = 4, 
                              loadings.label.hjust = -0.6, 
                              loadings.label.vjust = 0.5,
                              loadings.label.repel = TRUE) +
  scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  scale_fill_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  guides(fill = FALSE, color = guide_legend(keyheight = 0.3, nrow = 2, override.aes = list(linetype = c(0, 0))), shape = guide_legend(nrow = 2, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.3, y = -0.38, label = deparse(s_reef_pval), parse = TRUE, size = 3)

```

```{r combined PAST host v symb PCA plot, fig.width = 9, fig.height = 10}

## Combine PCAs by treatment for common legend:
PAST_host_symb_temp <- ggarrange(por_host_temp_pca, por_symb_temp_pca,ncol = 2, common.legend = TRUE, legend = "right")  # temperature
PAST_host_symb_pco2 <- ggarrange(por_host_pco2_pca, por_symb_pco2_pca,ncol = 2, common.legend = TRUE, legend = "right")  # pCO2
PAST_host_symb_reef <- ggarrange(por_host_reef_pca, por_symb_reef_pca,ncol = 2, common.legend = TRUE, legend = "right")  # reef

## Add all together for final figure:
ggarrange(PAST_host_symb_temp, PAST_host_symb_pco2, PAST_host_symb_reef, nrow = 3) +
  ggsave("Figures/Supplemental_Figures/FigureS4_PAST_PCA_hostVsymb.pdf", width = 9, height = 10) +
  ggsave("Figures/Supplemental_Figures/FigureS4_PAST_PCA_hostVsymb.png", width = 9, height = 10)


```

**Figure S4.** Principal component analysis (PCA) of P. asteroides coral host (protein, lipid, carbohydrate; left) or algal symbiont (chlorophyll a, symbiont density, colour intensity; right) physiological parameters by temperature (28 Â°C blue; 31 Â°C red), pCO2 (280 Î¼atm light purple; 400 Î¼atm dark purple; 700 Î¼atm light orange; 2800 Î¼atm dark orange), and natal reef environment (offshore green; inshore yellow). Arrows represent significant (p < 0.05) correlation vectors for physiological parameters and ellipses represent 95% confidence based on multivariate t-distributions.

<br/>
<br/>


### Figure S5

```{r all coral physiology plot, fig.width = 10, fig.height = 13}

## subset for the physiology parameters per species and convert from wide to long format
df_withT_phys <- gather(df_withT, param, value, c(14:17, 34, 38:39, 42))[,-13:-33]

# reorder the parameters and assign labels for plotting
df_withT_phys <- df_withT_phys %>% 
  mutate(param = factor(param, levels = c("carb", "lipid", "pro", "host", "chla", "den", "red", "sum"), labels = c(expression(paste("Carbohydrate (mg cm"^-2,")")), expression(paste("Lipid (mg cm"^-2,")")), expression(paste("Protein (mg cm"^-2,")")), expression(paste("Total Host (mg cm"^-2,")")), expression(paste("Chlorophyll a ("*mu,"g cm"^-2,")")), expression(paste("Density (10"^6,"cells cm"^-2,")")), expression(paste("Red"," channel")), expression(paste("Sum"," channel")))),
         species = factor(species, levels = c("S", "P", "A", "T"), labels = c(expression(paste(bold("A)  "), italic("Siderastrea siderea"))), expression(paste(bold("B)  "), italic("Pseudodiploria strigosa"))), expression(paste(bold("C)  "), italic("Porites astreoides"))), expression(paste(bold("D)  "), italic("Undaria tenuifolia"))))))


## Plot all phys for all species (mean, SE, and raw observations)
ggplot(df_withT_phys, aes(x = fpco2, y = value, colour = ftemp)) +
  theme_bw() +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(), strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.position = c(0.96, 0.982), legend.background = element_rect(fill = NA)) + 
  geom_point(alpha = 0.2, position = position_dodge(width = 0.3)) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = 0, position = position_dodge(width = 0.2)) +
  stat_summary(fun = "mean", size = 0.3, position = position_dodge(width = 0.2)) +
  scale_colour_manual("", labels = c("28 Â°C", "31 Â°C"), values = c("#4393c3", "#b2182b"))+
  facet_grid(param ~ species, scales = "free_y", labeller = label_parsed) +
  guides(color = guide_legend(override.aes = list(linetype = c(0, 0)))) +
  labs(y = "", x = alab) +
  ggsave("Figures/Supplemental_Figures/FigureS5_AllPhysiology.pdf", width = 10, height = 13) +
  ggsave("Figures/Supplemental_Figures/FigureS5_AllPhysiology.png", width = 10, height = 13) 

```

**Figure S5.** Mean ($\pm$SE) physiological parameter (each row) measured for (**A**) *S. siderea*, (**B**) *P. strigosa*, (**C**) *P. astreoides*, and (**D**) *U. tenuifolia* at the completion of the 93-day experimental period. 

<br/>
<br/>


### Figure S6

![](Figures/Supplemental_Figures/FigureS6_BleachingImages.png)

**Figure S6.** Coral colour changes over the experimental period. Representative images of fragments of (**A**) *P. astreoides*, (**B**) *S. siderea*, and (**C**) *P. strigosa* from the same colonies demonstrating change in coral colour over time in either control (400 Î¼atm; 28 Â°C) or warming (400 Î¼atm; 31 Â°C) treatments from the start of the experiment (T0) to the end (T90).

<br/>
<br/>


### Figure S7

```{r species PCA by reef plot, fig.width = 5.5, fig.height = 4.5}

autoplot(all_pca, data = all_df, 
                       colour = "reef",
                       fill = "reef",
                       frame = TRUE, 
                       frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
                       frame.level = 0.95, # using 95% CI for all ellipses
                       frame.alpha = 0.01,
                       loadings = TRUE, 
                       loadings.colour = "black", 
                       loadings.label = TRUE,
                       loadings.label.colour = "black",         
                       loadings.label.size = 4, 
                       loadings.label.hjust = 1.5, 
                       loadings.label.vjust = 0.5,
                       loadings.label.repel = TRUE) +
  scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  scale_fill_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  guides(fill = FALSE, color = guide_legend(keyheight = 0.3, nrow = 2, override.aes = list(linetype = c(0, 0))), shape = guide_legend(nrow = 2, override.aes = list(linetype = c(0, 0)))) +
  theme(legend.position = c(0.11, 0.9), legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.2, y = -0.108, label = deparse(all_reef_pval), parse = TRUE, size = 3) +
  annotate("text", x = -0.2, y = -0.128, label = deparse(all_s_reef_pval), parse = TRUE, size = 3) +
  ggsave("Figures/Supplemental_Figures/FigureS7_speciesPCA_reef.pdf", width = 5.5, height = 4.5) +
  ggsave("Figures/Supplemental_Figures/FigureS7_speciesPCA_reef.png", width = 5.5, height = 4.5)

```

**Figure S7.** Principal component analysis (PCA) comparing the coral holobiont of all three species at the end of the experiment depicted reef environment. Arrows represent significant (p < 0.05) correlation vectors for physiological parameters and ellipses represent 95% confidence based on multivariate t-distributions.

<br/>
<br/>


### Figure S8

```{r host v symb plasticity distance calculations }

#### SSID
# host
ssid_host_dist <- PCAplast(pca = s_pca_host, data = s_df)
ssid_host_dist_sum <- DistSum(data = ssid_host_dist)

# symbiont
ssid_symb_dist <- PCAplast(pca = s_pca_symb, data = s_df)
ssid_symb_dist_sum <- DistSum(data = ssid_symb_dist)


#### PSTR
# host
pstr_host_dist <- PCAplast(pca = p_pca_host, data = p_df)
pstr_host_dist_sum <- DistSum(data = pstr_host_dist)

# symbiont
pstr_symb_dist <- PCAplast(pca = p_pca_symb, data = p_df)
pstr_symb_dist_sum <- DistSum(data = pstr_symb_dist)


#### PAST
# host
past_host_dist <- PCAplast(pca = a_pca_host, data = a_df)
past_host_dist_sum <- DistSum(data = past_host_dist)

# symbiont
past_symb_dist <- PCAplast(pca = a_pca_symb, data = a_df)
past_symb_dist_sum <- DistSum(data = past_symb_dist)


#### Combined data by host or symbiont
## Host:
host_dist <- rbind(ssid_host_dist, pstr_host_dist, past_host_dist)
host_sum <- rbind(ssid_host_dist_sum, pstr_host_dist_sum, past_host_dist_sum)

## Symbionts:
symb_dist <- rbind(ssid_symb_dist, pstr_symb_dist, past_symb_dist)
symb_sum <- rbind(ssid_symb_dist_sum, pstr_symb_dist_sum, past_symb_dist_sum)

```

```{r host v symb plasticity analyses}

# add a 'part' label for combining datasets
host_dist$part <- rep("host", nrow(host_dist))
symb_dist$part <- rep("symb", nrow(symb_dist))

# combine datasets
combined_dist <- rbind(host_dist, symb_dist)




## Model selection (via AIC)
comb_dist_mod  <- glm(dist ~ species * part * reef * fpco2 * ftemp, family = Gamma(link = "log"), data = combined_dist)
comb_dist_mod2 <- glm(dist ~ species * part * reef * fpco2 + ftemp, family = Gamma(link = "log"), data = combined_dist)
comb_dist_mod3 <- glm(dist ~ species * part * reef + fpco2 * ftemp, family = Gamma(link = "log"), data = combined_dist)
comb_dist_mod4 <- glm(dist ~ species * reef + part + fpco2 + ftemp, family = Gamma(link = "log"), data = combined_dist) # best fit (AIC)
comb_dist_mod5 <- glm(dist ~ species * part * reef * (fpco2 + ftemp), family = Gamma(link = "log"), data = combined_dist)
comb_dist_mod6 <- glm(dist ~ species * part * fpco2 + ftemp, family = Gamma(link = "log"), data = combined_dist)
comb_dist_mod7 <- glm(dist ~ reef * species * part * (fpco2 + ftemp), family = Gamma(link = "log"), data = combined_dist) 
comb_dist_mod8 <- glm(dist ~ reef * species * part * (fpco2 + ftemp), family = Gamma(link = "log"), data = combined_dist) 

# check for best-fit model
comb_plast_aic <- compare_performance(comb_dist_mod, comb_dist_mod2, comb_dist_mod3, comb_dist_mod4, comb_dist_mod5, comb_dist_mod6, comb_dist_mod7, comb_dist_mod8, rank = TRUE)
plot(comb_plast_aic)


## Best-fit GLM with Gamma log link
comb_dist_glm <- glm(dist ~ species * reef + part + fpco2 + ftemp, family = Gamma(link = "log"), data = combined_dist, contrasts = list(species=contr.sum, part=contr.sum, reef=contr.sum, fpco2=contr.sum, ftemp=contr.sum))
comb_glm_out <- summary(comb_dist_glm) # summary output of the GLM
comb_anova_out <- Anova(comb_dist_glm, type = "III", test.statistic = "F") # comparison of the 'main effects'

```


```{r species labels for distance plots}

## Adding pretty species labels for all dataframes
host_sum <- host_sum %>% 
  mutate(species = factor(species, levels = c("S", "P", "A"), 
                          labels = c(expression(italic("Siderastrea siderea")), 
                                     expression(italic("Pseudodiploria strigosa")), 
                                     expression(italic("Porites astreoides")))))

host_dist <- host_dist %>% 
  mutate(species = factor(species, levels = c("S", "P", "A"), 
                          labels = c(expression(italic("Siderastrea siderea")), 
                                     expression(italic("Pseudodiploria strigosa")), 
                                     expression(italic("Porites astreoides")))))

symb_sum <- symb_sum %>% 
  mutate(species = factor(species, levels = c("S", "P", "A"), 
                          labels = c(expression(italic("Siderastrea siderea")), 
                                     expression(italic("Pseudodiploria strigosa")), 
                                     expression(italic("Porites astreoides")))))

symb_dist <- symb_dist %>% 
  mutate(species = factor(species, levels = c("S", "P", "A"), 
                          labels = c(expression(italic("Siderastrea siderea")), 
                                     expression(italic("Pseudodiploria strigosa")), 
                                     expression(italic("Porites astreoides")))))

```

```{r host v symb plasticity plots, fig.width = 9, fig.height = 9}

host_dist_plot <- ggplot(host_sum, aes(x = reef, y = mean, colour = treat_plot, fill = treat_plot, shape = treat_plot)) +
  theme_pubr() +
  theme(legend.title = element_blank(), axis.ticks.x = element_blank(), strip.background = element_rect(colour = "black", fill = NA)) +
  guides(shape = guide_legend(ncol = 1), fill = guide_legend(override.aes = list(linetype = 0)), color = guide_legend(override.aes = list(linetype = 0))) +
  geom_point(data = host_dist, aes(x = reef, y = dist), size = 2, alpha = 0.5, position = position_dodge(width = 0.55)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), alpha = 0.8, size = 1, width = 0, position = position_dodge(width = 0.55)) +
  geom_point(size = 3, stroke = 1, position = position_dodge(width = 0.55)) +
  scale_shape_manual(values = c(21, 21, 23, 24, 24, 22, 22)) +
  scale_colour_manual(values = c("#b2abd2", "#b2abd2", "#5e3c99", "#fdb863", "#fdb863", "#e66101", "#e66101")) + 
  scale_fill_manual(values = c("#b2abd2", "white", "white", "#fdb863", "white", "#e66101", "white")) + 
  labs(y = "Coral host plasticity", x = "") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 6)) +
  scale_x_discrete(labels = c("F" = "Offshore", "N" = "Inshore")) +
  facet_wrap(~ species, ncol = 1, labeller = label_parsed)


symb_dist_plot <- ggplot(symb_sum, aes(x = reef, y = mean, colour = treat_plot, fill = treat_plot, shape = treat_plot)) +
  theme_pubr() +
  theme(legend.title = element_blank(), axis.ticks.x = element_blank(), strip.background = element_rect(colour = "black", fill = NA)) +
  guides(shape = guide_legend(ncol = 1), fill = guide_legend(override.aes = list(linetype = 0)), color = guide_legend(override.aes = list(linetype = 0))) +
  geom_point(data = symb_dist, aes(x = reef, y = dist), size = 2, alpha = 0.5, position = position_dodge(width = 0.55)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), alpha = 0.8, size = 1, width = 0, position = position_dodge(width = 0.55)) +
  geom_point(size = 3, stroke = 1, position = position_dodge(width = 0.55)) +
  scale_shape_manual(values = c(21, 21, 23, 24, 24, 22, 22)) +
  scale_colour_manual(values = c("#b2abd2", "#b2abd2", "#5e3c99", "#fdb863", "#fdb863", "#e66101", "#e66101")) + 
  scale_fill_manual(values = c("#b2abd2", "white", "white", "#fdb863", "white", "#e66101", "white")) + 
  labs(y = "Algal symbiont plasticity", x = "") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 6)) +
  scale_x_discrete(labels = c("F" = "Offshore", "N" = "Inshore")) +
  facet_wrap(~ species, ncol = 1, labeller = label_parsed)


########### Full plot:

ggarrange(host_dist_plot, symb_dist_plot, nrow = 1, common.legend = TRUE, legend = "right", labels = "AUTO") +
  ggsave("Figures/Supplemental_Figures/FigureS8_hostVsymb_plasticity.pdf", width = 9, height = 9) +
  ggsave("Figures/Supplemental_Figures/FigureS8_hostVsymb_plasticity.png", width = 9, height = 9)


```


<br/>
<br/>


## Supplemental Tables{.tabset} 

### Table S1

**Table S1.** Model performance comparisons of generalized linear models (GLM) for plasticity assessments to select the best-fit model per species using the package *performance* (version `r packageVersion("performance")`). Akaike information criterion (AIC) was used to select the best-fit model per species. The performance score computes indices of model performance for all models per species at once for comparison across models.
```{r table S1 for markdown}

## Make table S1 with correct labels
plast_aic <- ssid_plast_aic %>% 
  bind_rows(pstr_plast_aic, past_plast_aic) %>% # combine all PERMANOVA model outputs
  separate(Name, c("Species", NA, "Formula")) %>% # create column for species ID and formula 
  mutate(Formula = gsub("mod2", Reduce(paste, deparse(ssid_dist_mod2[["formula"]])), Formula), # replace model name with formula
         Formula = gsub("mod3", Reduce(paste, deparse(ssid_dist_mod3[["formula"]])), Formula),
         Formula = gsub("mod4", Reduce(paste, deparse(ssid_dist_mod4[["formula"]])), Formula),
         Formula = gsub("mod5", Reduce(paste, deparse(ssid_dist_mod5[["formula"]])), Formula),
         Formula = gsub("mod6", Reduce(paste, deparse(ssid_dist_mod6[["formula"]])), Formula),
         Formula = gsub("mod", Reduce(paste, deparse(ssid_dist_mod[["formula"]])), Formula)) %>% 
  mutate(Formula = gsub("fpco2", "pCO2", Formula), # rename the formula components 
         Formula = gsub("ftemp", "temperature", Formula),
         Formula = gsub("reef", "reef environment", Formula),
         Formula = gsub("dist ~ ", "", Formula)) %>% 
  mutate(AIC = round(AIC, 2), # round the columns
         BIC = round(BIC, 2),
         R2_Nagelkerke = round(R2_Nagelkerke, 4),
         Performance_Score = (100 * round(Performance_Score, 3))) %>% 
  rename(`Performance score` = Performance_Score,
         `Model formula` = Formula,
         `Nagelkerke R2` = R2_Nagelkerke)
  
 
## combine them with format
table_s1 <- kable(plast_aic[c(-1, -3, -7, -8)], booktabs = TRUE, row.names = FALSE) %>%
  kable_styling(font_size = 12, full_width = FALSE) %>% 
  pack_rows("Siderastrea Siderea", 1, 6, italic = TRUE) %>%
  pack_rows("Pseudodiploria strigosa", 7, 12, italic = TRUE) %>%
  pack_rows("Porites astreoides", 13, 18, italic = TRUE)
table_s1

```

<br/>
<br/>

---

<br/>

### Table S2

**Table S2.** PERMANOVA model output from each species using the *adonis2* function with 1500 iterations.
```{r table S2 for markdown}

## combine model output
pca_mod_out <- rbind(s_pca_mod, p_pca_mod, a_pca_mod) # combine all PERMANOVA model outputs
pca_mod_out$treat <- rownames(pca_mod_out) # add column for rownames
pca_mod_out$species <- c(rep("SSID", 5), rep("PSTR", 5), rep("PAST", 5)) # add column for species ID
pca_mod_out <- pca_mod_out[c(6, 1:5, 7)] # reorder columns so treatment is first


## update formatting of text 
pca_mod_out <- pca_mod_out %>% 
  mutate(SumOfSqs = round(as.numeric(SumOfSqs), 0), # round values
         R2 = round(as.numeric(R2), 3),
         `F` = round(as.numeric(`F`), 2),
         `Pr(>F)` = round(as.numeric(`Pr(>F)`), 5)) %>% 
  mutate(treat = gsub("[0-9]", "", treat), # rename the treatment IDs
         treat = gsub("fpco", "pCO2", treat),
         treat = gsub("ftemp", "temperature", treat),
         treat = gsub("reef", "reef environment", treat)) %>% 
  rename("P-value" = `Pr(>F)`, # rename columns
         " " = treat,
         "Sum of Squares" = SumOfSqs)
  
## combine them with format
table_s2 <- kable(pca_mod_out[-7], booktabs = TRUE, row.names = FALSE) %>%
  kable_styling(font_size = 12, full_width = FALSE) %>% 
  pack_rows("Siderastrea Siderea", 1, 5, italic = TRUE) %>%
  pack_rows("Pseudodiploria strigosa", 6, 10, italic = TRUE) %>%
  pack_rows("Porites astreoides", 11, 15, italic = TRUE) %>% 
  row_spec(c(4:5,9:10,14:15), italic = TRUE)
table_s2

```

<br/>
<br/>

---

<br/>

### Table S3

**Table S3.** GLM output from plasticity assessments for each species. The intercept of each model was set as 300 $\mu$atm, 28$^\circ$C, and inshore reef environment.
```{r table S3 for markdown}

## combine model output per species
dist_mod_out <- rbind(tidy(ssid_dist_glm), tidy(pstr_dist_glm), tidy(past_dist_glm)) # combine all glm model outputs (the use of tidy() makes a tibble from the GLM)
dist_mod_out$species <- c(rep("SSID", 9), rep("PSTR", 6), rep("PAST", 6)) # add column for species ID


## update formatting of text 
dist_mod_out <- dist_mod_out %>% 
  mutate(estimate = round(as.numeric(estimate), 3), # round values
         std.error = round(as.numeric(std.error), 3),
         statistic = round(as.numeric(statistic), 2),
         p.value = round(as.numeric(p.value), 3)) %>% 
  mutate(term = gsub("21", "-current", term), # rename the treatment IDs
         term = gsub("22", "-EOC", term),
         term = gsub("23", "-extreme", term),
         term = gsub("[0-9]", "", term),
         term = gsub("fpco", "pCO2", term),
         term = gsub("ftemp", "temperature (31C)", term),
         term = gsub("reef", "reef environment (offshore)", term)) %>% 
  rename(" " = term, # rename columns
        "Estimate" = estimate,
        "Standard error" = std.error,
        "Statistic" = statistic,
        "P-value" = p.value)
  
## combine them with format
table_s3 <- kable(dist_mod_out[-6], booktabs = TRUE, row.names = FALSE) %>%
  kable_styling(font_size = 12, full_width = FALSE) %>% 
  pack_rows("Siderastrea Siderea", 1, 9, italic = TRUE) %>%
  pack_rows("Pseudodiploria strigosa", 10, 15, italic = TRUE) %>%
  pack_rows("Porites astreoides", 16, 21, italic = TRUE)
table_s3

```

<br/>
<br/>

---

<br/>

### Table S4

**Table S4.** Type III test of analysis of deviance output based on the plasticity GLM per species in **Table S3**.
```{r table S4 for markdown}

## combine ANOVA output per species
anova_mod_out <- rbind(ssid_anova_out, pstr_anova_out, past_anova_out) # combine all ANOVA model outputs
anova_mod_out$treat <- rownames(anova_mod_out) # add column for rownames
anova_mod_out$species <- c(rep("SSID", 5), rep("PSTR", 4), rep("PAST", 4)) # add column for species ID
anova_mod_out <- anova_mod_out[c(5, 1:4, 6)] # reorder columns so treatment is first


## update formatting of text 
anova_mod_out <- anova_mod_out %>% 
  mutate(`Sum Sq` = round(as.numeric(`Sum Sq`), 2), # round values
         `F values` = round(as.numeric(`F values`), 1),
         `Pr(>F)` = round(as.numeric(`Pr(>F)`), 2)) %>% 
  mutate(treat = gsub("[0-9]", "", treat), # rename the treatment IDs
         treat = gsub("fpco", "pCO2", treat),
         treat = gsub("ftemp", "temperature", treat),
         treat = gsub("reef", "reef environment", treat)) %>% 
  rename("P-value" = `Pr(>F)`, # rename columns
         " " = treat,
         "Sum of Squares" = `Sum Sq`)
  
## combine them with format
table_s4 <- kable(anova_mod_out[-6], booktabs = TRUE, row.names = FALSE) %>%
  kable_styling(font_size = 12, full_width = FALSE) %>% 
  pack_rows("Siderastrea Siderea", 1, 5, italic = TRUE) %>%
  pack_rows("Pseudodiploria strigosa", 6, 9, italic = TRUE) %>%
  pack_rows("Porites astreoides", 10, 13, italic = TRUE) %>% 
  row_spec(c(5,9,13), italic = TRUE)
table_s4

```

<br/>
<br/>

---

<br/>

### Table S5

**Table S5.** PERMANOVA model output across species using the *adonis2* function with 1500 iterations.
```{r table S5 for markdown}

## combine model output
all_pca_mod$treat <- rownames(all_pca_mod) # add column for rownames
all_pca_mod <- all_pca_mod[c(6, 1:5)] # reorder columns so treatment is first


## update formatting of text 
all_pca_mod <- all_pca_mod %>% 
  mutate(SumOfSqs = round(as.numeric(SumOfSqs), 0), # round values
         R2 = round(as.numeric(R2), 3),
         `F` = round(as.numeric(`F`), 2),
         `Pr(>F)` = round(as.numeric(`Pr(>F)`), 5)) %>% 
  mutate(treat = gsub("[0-9]", "", treat), # rename the treatment IDs
         treat = gsub("fpco", "pCO2", treat),
         treat = gsub("ftemp", "temperature", treat),
         treat = gsub("reef", "reef environment", treat)) %>% 
  rename("P-value" = `Pr(>F)`, # rename columns
         " " = treat,
         "Sum of Squares" = SumOfSqs)
  
## combine them with format
table_s5 <- kable(all_pca_mod, booktabs = TRUE, row.names = FALSE) %>%
  kable_styling(font_size = 12, full_width = FALSE) %>% 
  row_spec(c(8:9), italic = TRUE)
table_s5

```


<br/>
<br/>

---

<br/>

### Table S6

**Table S6.** PERMANOVA model output of coral host or algal symbiont physiology per species using the *adonis2* function with 1500 iterations depicted in **Figures S2-S4**.
```{r table S6 for markdown}

## combine model output
pca_host_mod_out <- rbind(s_pca_host_mod, p_pca_host_mod, a_pca_host_mod) # combine all PERMANOVA model outputs
pca_symb_mod_out <- rbind(s_pca_symb_mod, p_pca_symb_mod, a_pca_symb_mod) # combine all PERMANOVA model outputs
pca_host_symb_mod_out <- cbind(pca_host_mod_out, pca_symb_mod_out)


pca_host_symb_mod_out$treat <- rownames(pca_host_symb_mod_out) # add column for rownames
pca_host_symb_mod_out$species <- c(rep("SSID", 5), rep("PSTR", 5), rep("PAST", 5)) # add column for species ID
pca_host_symb_mod_out <- pca_host_symb_mod_out[c(11, 1:10, 12)] # reorder columns so treatment is first


## update formatting of text 
pca_host_symb_mod_out <- pca_host_symb_mod_out %>% 
  mutate(SumOfSqs = round(as.numeric(SumOfSqs), 0), # round values from host
         R2 = round(as.numeric(R2), 3),
         `F` = round(as.numeric(`F`), 2),
         `Pr(>F)` = round(as.numeric(`Pr(>F)`), 5)) %>% 
  mutate(SumOfSqs.1 = round(as.numeric(SumOfSqs.1), 0), # round values from symbiont
         R2.1 = round(as.numeric(R2.1), 3),
         `F.1` = round(as.numeric(`F.1`), 2),
         `Pr(>F).1` = round(as.numeric(`Pr(>F).1`), 5)) %>% 
  mutate(treat = gsub("[0-9]", "", treat), # rename the treatment IDs
         treat = gsub("fpco", "pCO2", treat),
         treat = gsub("ftemp", "temperature", treat),
         treat = gsub("reef", "reef environment", treat)) %>% 
  rename("P-value" = `Pr(>F)`, # rename columns
         " " = treat,
         "Sum of Squares" = SumOfSqs,
         "Df " = Df.1,
         "Sum of Squares " = SumOfSqs.1,
         "R2 " = R2.1,
         "F " = F.1,
         "P-value " = `Pr(>F).1`)
  
## combine them with format
table_s6 <- kable(pca_host_symb_mod_out[-12], booktabs = TRUE, row.names = FALSE) %>%
  kable_styling(font_size = 12, full_width = FALSE) %>% 
  add_header_above(c(" " = 1, "Coral host" = 5, "Algal symbionts" = 5)) %>% 
  pack_rows("Siderastrea Siderea", 1, 5, italic = TRUE) %>%
  pack_rows("Pseudodiploria strigosa", 6, 10, italic = TRUE) %>%
  pack_rows("Porites astreoides", 11, 15, italic = TRUE) %>% 
  row_spec(c(4:5,9:10,14:15), italic = TRUE)
table_s6

```


<br/>
<br/>

---

<br/>

```{r excel WB, message=FALSE, warning=FALSE}

### Create workbook
wb <- createWorkbook()

# add 'Table S1' worksheet
addWorksheet(wb, "Table S1 - Plasticity AIC") 
writeData(wb, sheet = 1, x = plast_aic)
setColWidths(wb, sheet = 1, cols = 1:7, widths = "auto")

# add 'Table S2' worksheet
addWorksheet(wb, "Table S2 - PERMANOVA") 
writeData(wb, sheet = 2, x = pca_mod_out)
setColWidths(wb, sheet = 2, cols = 1:7, widths = "auto")

# add 'Table S3' worksheet
addWorksheet(wb, "Table S3 - Plasticity GLM") 
writeData(wb, sheet = 3, x = dist_mod_out)
setColWidths(wb, sheet = 3, cols = 1:6, widths = "auto")

# add 'Table S4' worksheet
addWorksheet(wb, "Table S4 - Plasticity ANOVA") 
writeData(wb, sheet = 4, x = anova_mod_out)
setColWidths(wb, sheet = 4, cols = 1:6, widths = "auto")

# add 'Table S5' worksheet
addWorksheet(wb, "Table S5 - Species PERMANOVA") 
writeData(wb, sheet = 5, x = all_pca_mod)
setColWidths(wb, sheet = 5, cols = 1:6, widths = "auto")

# add 'Table S6' worksheet
addWorksheet(wb, "Table S6 - HostVsymb PERMANOVA") 
writeData(wb, sheet = 6, x = pca_host_symb_mod_out)
setColWidths(wb, sheet = 6, cols = 1:12, widths = "auto")


# save workbook
saveWorkbook(wb, file="Data/Supplemental/Supplemental_Tables.xlsx", overwrite = TRUE)


```


## Session information

Session information from the last run date on `r date`:
```{r}

sessionInfo()

```


