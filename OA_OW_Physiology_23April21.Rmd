---
title: "Coral Holobiont Physiology under OA/OW "
output: 
  html_document:
    theme: simplex
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

<style>
  h2{color: teal !important}
  h1{color: navy !important}
  body{background-color: gray95 !important}
</style>

<br/>

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(warn = -1)

```

```{r packages, include=FALSE}

#library("devtools")
#install_github("vqv/ggbiplot") # need this to download ggbiplot if not already installed

## Packages to load
library(knitr)
library(readr)
library(ggplot2)
library(dplyr)
library(ggbiplot)
library(tidyr)
library(corrgram)
library(openxlsx)
library(plotly)
library(tidyverse)
library(vegan)
library(shiny)
library(Rmisc)
library(cowplot)
library(ggfortify)
library(finalfit)
library(kableExtra)
library(readr)
library(lmerTest)
library(vroom)
library(ggpubr)
library(magick)
library(Hmisc)
library(corrplot)
library(gridGraphics)
library(grid)
library(RColorBrewer)
library(wesanderson)
library(performance)
library(MASS)
library(png)

```

```{r set formatting and labels, include=FALSE}

## Set some standards and units

# dodge width
dodge=position_dodge(width=0.3)
dodge2=position_dodge(width = 0.6)
jitter=position_jitter(width=0.1)

# set figure theme
theme_set(theme_bw())

# set parameter labels
Tlab<-"Temperature (Â°C)"
alab<-expression(paste(italic("p"),"CO" [2]~ "("*mu,'atm)'))
dlab<-expression(paste("Cell density (10"^6,"cells cm"^-2,")"))
plab<-expression(paste("Total protein (mg cm"^-2,")"))
calab<-expression(paste("Carbohydrate (mg cm"^-2,")"))
clab<-expression(paste("Chlorophyll a ("*mu,"g cm"^-2,")"))
rlab<-expression(paste("Calcification rate (mg cm"^-2~"day"^-1,")"))
llab<-expression(paste("Total Lipid (mg cm"^-2,")"))
hlab<-expression(paste("Total Host (mg cm"^-2,")"))

# set the current date
date <- Sys.Date() 

```

```{r original dataframe adjustment, include=FALSE}

#df <- read_csv("Data/Raw_data/phys_all_21Oct19.csv") # read in full dataframe
#den_count <- read_csv("/Users/colleen/Dropbox/Grad school/UNC_PhD_Folders/Boston_Experiment/Physiology/Symbiont #Density/density_ForAddition_23Mar21.csv")
#
#test <- merge(df, den_count, by = "coral")
#test$X1 <- NULL
#test$X1_1 <- NULL 
#
#write.csv(test, "Data/Raw_data/phys_all_23March2021.csv")

df <- read_csv("Data/Raw_data/phys_all_23March2021.csv") # read in full dataframe
df$X1 <- NULL

# rename a couple columns
names(df)[38]<-"carb"
names(df)[39]<-"lipid"
names(df)[17]<-"sum"
names(df)[34]<-"red" 

# set columns as factors
df$ftemp <- as.factor(df$ftemp)
df$fpco2 <- as.factor(df$fpco2)
df$colony <- as.factor(df$colony)
df$species <- factor(df$species, levels = c("S", "P", "A", "T")) # and reorder these

# replace some pCO2 values with ones we will use moving forward
df$fpco2 <- gsub("2800", "3300", df$fpco2)
df$fpco2 <- gsub("280", "300", df$fpco2)
df$fpco2 <- gsub("400", "420", df$fpco2)
df$fpco2 <- gsub("700", "680", df$fpco2)

# reorder factors for pCO2 and temp
df$fpco2 <- factor(df$fpco2, c("420", "T0", "300", "680", "3300"))
df$ftemp <- factor(df$ftemp, c("28", "T0", "31"))

# calculate phys parameters
df$den <- df$den / 1000000 # adjust symbiont density to display 10^6 cells
df$host <- df$pro + df$carb + df$lipid # calculate total host energy reserves (sum of carb, protein, lipids)
df$treat[df$T0_T90 == "T0"] <- "T0" # replace T0 'treat' with T0 text
df$treat <- factor(df$treat, c("T0", "288_28", "311_31", "447_28", "405_31", "673_28", "701_31", "3285_28", "3309_31")) # adjust treatment levels

# add a new treat column for plotting (replacing actual treatment with number for better plotting - see plot XX)
df$treat2 <- df$treat
df$treat <- gsub("T0", 2, df$treat)
df$treat <- gsub("288_28", 4, df$treat)
df$treat <- gsub("311_31", 4, df$treat)
df$treat <- gsub("447_28", 6, df$treat)
df$treat <- gsub("405_31", 6, df$treat)
df$treat <- gsub("673_28", 8, df$treat)
df$treat <- gsub("701_31", 8, df$treat)
df$treat <- gsub("3285_28", 10, df$treat)
df$treat <- gsub("3309_31", 10, df$treat)
df$treat <- as.numeric(df$treat) # convert 'treat' column to numerics (again, this is for plotting only)

# inverse of colours (so lower colour depicts more bleached coral)
df$sum <- (df$sum * -1)
df$red <- (df$red * -1)
df$blue_bw5 <- (df$blue_bw5 * -1)
df$green_bw5 <- (df$green_bw5 * -1)

## modify dataframe for simplified version
df2 <- df[,c(1:13, 41, 14:16, 37:40, 42:43, 17)] # select columns of interest only
df2 <- gather(df2, param, value, den:sum) # make column of parameter and value
df2$param <- factor(df2$param, levels = c("pro", "carb", "lipid", "den", "chla", "host", "count")) # reorder parameters
df2$species <- revalue(x = df2$species, c("S" = "SSID", "P" = "PSTR", "A" = "PAST", "T" = "UTEN")) # rename the species codes
df2 <- subset(df2, species != "UTEN") # remove UTEN (omitted due to high mortality in some treatments)

## remote T0 samples from dataframe for models
df2_T90 <- subset(df2, T0_T90 == "T90")

## add treatment column
df2_T90$treat2 <- paste0(df2_T90$fpco2, df2_T90$temp)

```

```{r bootstrap model setup}

## Function to remove rows with any missing values
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

## Performing the parametric bootstrapping of the model:
bootnum = 1500 # set number of iterations (we used 2000) between 999 and 9999
seed = 3 #seed to make results replicatable (our seed was 7)
set.seed(3)

## This is a bootstrap function that will sample WITH replacement (explained step by step within the function)
bootFUN <- function(model, newdata) {
  nr <- nrow(model$data) # count number of rows in the model (# of observations)
  data <- model$data # pull data from model
  data <- data[sample(1:nr, size = nr, replace = TRUE), ] # random sample of numbers from 1 - nr (# of rows) to select data from
  update <- update(model, data = data) # rerun the model using the 'new' dataset from the random smapling above
  predict(update, newdata = newdata, type = "response") # predicts response variable with model and updated data 
}

#bootFUN <- function(model, newdata) {
#  nr <- nrow(model$data) # count number of rows in the model (# of observations)
#  data <- model$data # pull data from model
#  
#  colnames(newdata)
#
#  data %>% group_by() %>% sample_frac(.5)
#  
#  #data <- data[sample(1:nr, size = nr, replace = TRUE), ] # random sample of numbers from 1 - nr (# of rows) to select data from
#  #update <- update(model, data = data) # rerun the model using the 'new' dataset from the random smapling above
#  #predict(update, newdata = newdata, type = "response") # predicts response variable with model and updated data 
#}

```

```{r create dataframe per parameter}

## Create a forloop to subset the data by each parameter and save as individual dataframes 

# make a list of parameter names
param_list <- levels(df2_T90$param)

# forloop for dataframes
for (p in 1:length(param_list)) {
  param_select <- param_list[p]
  df_subset <- subset(df2_T90, param == param_select) # subset the dataframe for only one parameter
  df_subset <- completeFun(df_subset, "value") # run function to remove any missing values
  df_subset$value <- as.numeric(df_subset$value)
  df_subset$ftemp <- droplevels(df_subset$ftemp)
  df_subset$fpco2 <- droplevels(df_subset$fpco2)
  df_subset$colony <- droplevels(df_subset$colony)
  df_subset$species <- droplevels(df_subset$species)
  assign(paste(param_select, "mod_df", sep = "_"), df_subset) # assign the data to dataframe named for each parameter 
}

```

```{r T90 df setup}

df_90 <- subset(df, T0_T90 == "T90") 
df_90 <- subset(df_90, species != "T") 
df_90 <- df_90[,-c(18:33)]
df_90 <- completeFun(df_90, "den")
df_90 <- completeFun(df_90, "host")
df_90 <- completeFun(df_90, "lipid")
df_90 <- completeFun(df_90, "carb")
df_90_l <- gather(df_90, param, value, 14:23)

## specific species dataframes
s_df <- subset(df_90, species == "S") 
p_df <- subset(df_90, species == "P") 
a_df <- subset(df_90, species == "A") 

```

```{r add in the SSID dominant symbionts}

symbs <- read.csv("Data/Raw_data/domSSID_symbiont.csv")[,c(2,3,5)]

symbs <- symbs %>% 
  mutate(domSymb = ifelse(percent > 70, "C", ifelse((percent < 70 & percent > 30), "mix", "D")))

s_df <- s_df %>% 
  left_join(symbs, by = c("coral" = "Sample"))

df_90 <- df_90 %>% 
  left_join(symbs, by = c("coral" = "Sample"))

```


## Principal component analyses {.tabset}

#### *Methods:*
Principal component analysis (PCA) (function *prcomp*) of scaled and centered physiological parameters (host carbohydrate, host lipid, host protein, algal endosymbiont chlorophyll a, algal endosymbiont cell density, holobiont calcification rate as previously for the same samples in Bove et al. (2019)) were employed to assess the relationship between physiological parameters and treatment conditions for each coral species. Main effects (temperature, *p*CO~2~, and reef environment) were evaluated using the *adonis2* function (*vegan* package; version `r packageVersion("vegan")`) (**Tables XXX**).

<br/>

#### *Results:*
*Text for results of PCA will go here*

<br/>

### *Siderastrea siderea*

```{r SSID PCA}

# set up the dataframe
s_df <- unique(s_df) # remove any duplicate rows
s_df_l <- gather(s_df, param, value, c(14:17,21:23))
s_df$fpco2 <- factor(s_df$fpco2, levels = c("300", "420", "680", "3300"))
sid_pca_df <- s_df[,c(14:17,21:23)]

# run the adonis
#s_pca_mod <- adonis2(sid_pca_df ~ reef * ftemp * fpco2, data = s_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
s_pca_mod <- adonis2(sid_pca_df ~ fpco2 + ftemp + reef, data = s_df, method = 'eu', permutations = bootnum)
s_pca_mod # view SSID adonis output

# extract pvalues
s_pval <- s_pca_mod["Pr(>F)"]

# perform principal component analysis (PCA)
s_pca <- prcomp(sid_pca_df, center = TRUE, scale= TRUE)

```

```{r SSID PCA plot, fig.height=8, fig.width=8}

# create labels for p values calculated above
s_reef_pval <-substitute(italic(P[reef])==p, list(p = format(s_pval[1,1], digits = 2)))
s_temp_pval <-substitute(italic(P[temp])==p, list(p = format(s_pval[2,1], digits = 3)))
s_pco2_pval <-substitute(italic(P[pCO[2]])==p, list(p = format(s_pval[3,1], digits = 2)))


# temperature
s_temp_pca <- autoplot(s_pca, data = s_df, 
         colour = "ftemp",
         shape = "fpco2",
         fill = "ftemp",               
         frame = TRUE, 
         frame.type = "t", # displaying ellipses with multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95, # using 95% CI for all ellipses
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 1.5, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  scale_shape_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21,22,23,24)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
    guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(),strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.30, y = -0.38, label = deparse(s_temp_pval), parse = TRUE, size = 3) +
  ggtitle(expression(paste(bold("A)   "), italic("S. siderea"))))

# pco2
s_pco2_pca <- autoplot(s_pca, data = s_df, 
         colour = "fpco2",
         shape = "ftemp",
         frame = TRUE, 
         frame.type = "t",
         frame.level = 0.95,
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 1.5, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
    scale_shape_manual("temperature", labels = c("28 C", "31 C"), values = c(19,21)) +
    scale_fill_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(NA, NA, NA, NA))+
    scale_colour_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
    guides(fill = FALSE, color = guide_legend(order = 1, keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0, 0, 0)))) +
    theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(), strip.background = element_blank(), legend.title = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.30, y = -0.38, label = deparse(s_pco2_pval), parse = TRUE, size = 3)

# reef
s_reef_pca <- autoplot(s_pca, data = s_df, 
         colour = "reef",
         shape = "reef",
         fill = "reef",               
         frame = TRUE, 
         frame.type = "t",
         frame.level = 0.95,
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 1.5, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  #scale_shape_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21,22,23,24)) +
  #scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
  #scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
  scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(),strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.345, y = -0.38, label = deparse(s_reef_pval), parse = TRUE, size = 3)

```

<br/>
<br/>


### *Pseudodiploria strigosa*

```{r PSTR PCA}

# set up the dataframe
p_df <- unique(p_df) # remove duplicate rows
p_df_l <- gather(p_df, param, value, c(14:16,21:23))
p_df$fpco2 <- factor(p_df$fpco2, levels = c("300", "420", "680", "3300"))
dip_pca_df <- p_df[,c(14:17,21:23)]

# run the adonis
#p_pca_mod <- adonis2(dip_pca_df ~ reef * ftemp * fpco2, data = p_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
p_pca_mod <- adonis2(dip_pca_df ~ reef + fpco2 + ftemp, data = p_df, method = 'eu', permutations = bootnum)
p_pca_mod # view PSTR adonis output

# extract pvalues
p_pval <- p_pca_mod["Pr(>F)"]

# perform principal component analysis (PCA)
p_pca <- prcomp(dip_pca_df, center = TRUE, scale= TRUE)

```

```{r PSTR PCA plot, fig.height=8, fig.width=8}

# create labels for p values calculated above
p_reef_pval <-substitute(italic(P[reef])==p, list(p = format(p_pval[1,1], digits = 2)))
p_temp_pval <-substitute(italic(P[temp])==p, list(p = format(p_pval[2,1], digits = 3)))
p_pco2_pval <-substitute(italic(P[pCO[2]])==p, list(p = format(p_pval[3,1], digits = 2)))


# temperature
p_temp_pca <- autoplot(p_pca, data = p_df, 
         colour = "ftemp",
         shape = "fpco2",
         fill = "ftemp",               
         frame = TRUE, 
         frame.type = "t",
         frame.level = 0.95,
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 1, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  scale_shape_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21,22,23,24)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
    guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(),strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.15, y = -0.38, label = deparse(p_temp_pval), parse = TRUE, size = 3) +
  ggtitle(expression(paste(bold("B)   "), italic("P. strigosa"))))

# pco2
p_pco2_pca <- autoplot(p_pca, data = p_df, 
         colour = "fpco2",
         shape = "ftemp",
         frame = TRUE, 
         frame.type = "t",
         frame.level = 0.95,
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 1, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
    scale_shape_manual("temperature", labels = c("28 C", "31 C"), values = c(19,21)) +
    scale_fill_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(NA, NA, NA, NA))+
    scale_colour_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
    guides(fill = FALSE, color = guide_legend(order = 1, keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0, 0, 0)))) +
    theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(), strip.background = element_blank(), legend.title = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.285, y = -0.38, label = deparse(p_pco2_pval), parse = TRUE, size = 3)

# reef
p_reef_pca <- autoplot(p_pca, data = p_df, 
         colour = "reef",
         shape = "reef",
         fill = "reef",               
         frame = TRUE, 
         frame.type = "t",
         frame.level = 0.95,
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 1.5, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  #scale_shape_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21,22,23,24)) +
  #scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
  #scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
    guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(),strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.345, y = -0.38, label = deparse(p_reef_pval), parse = TRUE, size = 3)

```

<br/>
<br/>


### *Porites astreoides*

```{r PAST PCA}

# set up the dataframe
a_df <- unique(a_df)
a_df <- a_df[-17,] # we have two from the same colony in 400_28 that are performing similarly so one is being removed (CFAD12)
a_df_l <- gather(a_df, param, value, c(14:16,21:23))
a_df$fpco2 <- factor(a_df$fpco2, levels = c("300", "420", "680", "3300"))
por_pca_df <- a_df[,c(14:16,18,21:23)]

# run the adonis
#a_pca_mod <- adonis2(por_pca_df ~ fpco2 * ftemp * reef, data = a_df, method = 'eu', permutations = 1000) # below is the model with non sig interactions removed:
a_pca_mod <- adonis2(por_pca_df ~ reef + ftemp + fpco2, data = a_df, method = 'eu', permutations = bootnum)
a_pca_mod # view PAST adonis output

# extract pvalues
a_pval <- a_pca_mod["Pr(>F)"]

# perform principal component analysis (PCA)
a_pca <- prcomp(por_pca_df, center = TRUE, scale= TRUE)

```

```{r PAST PCA plot, fig.height=8, fig.width=8}

# create labels for p values calculated above
a_reef_pval <-substitute(italic(P[reef])==p, list(p = format(a_pval[1,1], digits = 2)))
a_temp_pval <-substitute(italic(P[temp])==p, list(p = format(a_pval[2,1], digits = 3)))
a_pco2_pval <-substitute(italic(P[pCO[2]])==p, list(p = format(a_pval[3,1], digits = 2)))


# temperature
a_temp_pca <- autoplot(a_pca, data = a_df, 
         colour = "ftemp",
         shape = "fpco2",
         fill = "ftemp",               
         frame = TRUE, 
         frame.type = "t",
         frame.level = 0.95,
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = -0.6, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  scale_shape_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21,22,23,24)) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
    guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(),strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.245, y = -0.44, label = deparse(a_temp_pval), parse = TRUE, size = 3) +
  ggtitle(expression(paste(bold("C)   "), italic("P. astreoides"))))

# pco2
a_pco2_pca <- autoplot(a_pca, data = a_df, 
         colour = "fpco2",
         shape = "ftemp",
         frame = TRUE, 
         frame.type = "t",
         frame.level = 0.95,
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = -0.6, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
    scale_shape_manual("temperature", labels = c("28 C", "31 C"), values = c(19,21)) +
    scale_fill_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(NA, NA, NA, NA))+
    scale_colour_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
    guides(fill = FALSE, color = guide_legend(order = 1, keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0, 0, 0)))) +
    theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(), strip.background = element_blank(), legend.title = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.167, y = -0.5, label = deparse(a_pco2_pval), parse = TRUE, size = 3)

# reef
a_reef_pca <- autoplot(a_pca, data = a_df, 
         colour = "reef",
         shape = "reef",
         fill = "reef",               
         frame = TRUE, 
         frame.type = "t",
         frame.level = 0.95,
         frame.alpha = 0.01,
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 1.5, 
         loadings.label.vjust = 0.5,
         loadings.label.repel = TRUE) +
  #scale_shape_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(21,22,23,24)) +
  #scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
  #scale_fill_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
    guides(color = guide_legend(keyheight = 0.3, nrow = 4, byrow = TRUE, override.aes = list(linetype = c(0, 0)))) +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(),strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank(), legend.background = element_rect(fill = "transparent", colour = NA)) +
  annotate("text", x = -0.345, y = -0.38, label = deparse(a_reef_pval), parse = TRUE, size = 3)

```

<br/>
<br/>


### **Figure 1**

```{r PCA plot, fig.height=7, fig.width=13}

temp_PCA <- ggarrange(s_temp_pca, p_temp_pca, a_temp_pca, ncol = 3, common.legend = TRUE, legend = "right")
pCO2_PCA <- ggarrange(s_pco2_pca, p_pco2_pca, a_pco2_pca, ncol = 3, common.legend = TRUE, legend = "right")
#reef_PCA <- ggarrange(s_reef_pca, p_reef_pca, a_reef_pca, ncol = 3, common.legend = TRUE, legend = "right") # includes a row for RZ

ggarrange(temp_PCA, pCO2_PCA, nrow = 2) +
  ggsave("Figures/Final_Figures/Figure1_PhysPCA.pdf", width = 13, height = 7)

```

**Figure 1.** Principal component analysis (PCA) of all coral holobiont physiological parameters for *S. siderea* (**A**), *P. strigosa* (**B**), and *P. astreoides* (**C**) after 93 days of exposure to different temperature and *p*CO~2~ treatments. PCAs in the top row are depicted by temperature treatment for each species (28$^\circ$ C blue; 31$^\circ$ C red) and the bottom row of PCAs are depicted by *p*CO~2~ for each species (280 $\mu$atm light purple; 400 $\mu$atm dark purple; 700 $\mu$atm light orange; 2800 $\mu$atm dark orange). Arrows represent significant (p < 0.05) correlation vectors for physiological parameters and ellipses represent 95% confidence based on multivariate t-distributions.


<br/>
<br/>


## Correlation assessments {.tabset}

#### *Methods:*
Correlations of all physiological parameters were assessed to determine the relationships between parameters within each species. The strength (R^2^) of each correlation was calculated using the corrgram package (version `r packageVersion("corrgram")`) and the significance was calculated using the cor.test() function. These relationships were then visualized through simple scatterplots.

<br/>

#### *Results:*
*Text for results of correlations will go here*

<br/>

```{r functions for custom correlation and scatter plots}

## Custom function for the border around the text
panel.txt.brdr <- function (x = 0.5, y = 0.5, txt, cex, font, srt) 
{
  text(x, y, txt, cex = cex, font = font, srt = srt)
  box(col = "#525252")
}

## Custom function for the top point fill/shape panel
panel.pts.col <- function (x, y, corr = NULL, col.regions, cor.method, color, ...) 
{
  if (!is.null(corr)) 
    return()
  plot.xy(xy.coords(x, y), col = color, type = "p", ...)
  box(col = "#525252")
}

## Custom function for the bottom fill/R2 panel (with significance)
panel.fill.R2 <- function (x, y, corr = NULL, col.regions, cor.method, digits = 2, cex.cor, ...) 
{
  if (is.null(corr)) {
    if (sum(complete.cases(x, y)) < 2) {
      warning("Need at least 2 complete cases for cor()")
      return()
    }
    else {
      corr <- cor(x, y, use = "pair", method = cor.method)
    }
  }
  ncol <- 14
  pal <- col.regions(ncol)
  col.ind <- as.numeric(cut(corr, breaks = seq(from = -1, 
                                               to = 1, length.out = ncol + 1), include.lowest = TRUE))
  usr <- par("usr")
  rect(usr[1], usr[3], usr[2], usr[4], col = pal[col.ind], 
       border = NA)
  box(col = "#525252")
  
  auto <- missing(cex.cor)
  on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  abscorr <- formatC(abs(corr), digits = digits, format = "f")
  corr2 <- formatC(corr, digits = digits, format = "f")
  pval <- cor.test(x, y, use = "pair", method = cor.method)[["p.value"]]
  sig <- if(pval > 0.05){""}else if(pval < 0.05 & pval > 0.01){"*"}else if(pval < 0.01 & pval > 0.001){"**"}else if(pval < 0.001){"***"}
  if (auto) 
    cex.cor <- 0.4/strwidth(abscorr)
  text(0.5, 0.5, paste0(corr2, sig), cex = cex.cor, font = 3, col = "#252525")
  
  
  
}

```

```{r SSID correlation matrix and scatter plots, results='hide'}

## Create new correlation dataframe for SSID
sid_corr_df <- s_df[,c(10:11,14:17,21:23)] %>% 
  mutate(shape = case_when(ftemp == "28" ~ "19",
                           ftemp == "31" ~ "21"),
         colour = case_when(fpco2 == "300" ~ "#b2abd2",
                            fpco2 == "420" ~ "#5e3c99",
                            fpco2 == "680" ~ "#fdb863",
                            fpco2 == "3300" ~ "#e66101"))

## Plot correlation matrix and scatter plot of all SSID physiology  
png(file = "Figures/Supplemental_Figures/SSID_PhysCorrelations.png", width = 330, height = 225, units='mm', res = 300)  

corrgram(sid_corr_df, order = TRUE, lower.panel = panel.fill.R2, upper.panel = panel.pts.col, text.panel = panel.txt.brdr,
         col.regions = colorRampPalette(c("#ffffcc", "#c7e9b4", "#225ea8")), 
         color = sid_corr_df$colour, pch = as.numeric(as.character(sid_corr_df$shape)),
         labels = c("symbiont \ndensity", "host \nprotein", "chlorophyll a", "colour \nintensity", "calcification \nrate", "host \ncarbohydrate", "host \nlipid")) 

dev.off() 

```

```{r PSTR correlation matrix and scatter plots, results='hide'}

## Create new correlation dataframe for SSID
dip_corr_df <- p_df[,c(10:11,14:17,21:23)] %>% 
  mutate(shape = case_when(ftemp == "28" ~ "19",
                           ftemp == "31" ~ "21"),
         colour = case_when(fpco2 == "300" ~ "#b2abd2",
                            fpco2 == "420" ~ "#5e3c99",
                            fpco2 == "680" ~ "#fdb863",
                            fpco2 == "3300" ~ "#e66101"))
  

## Plot correlation matrix and scatter plot of all PSTR physiology
png(file = "Figures/Supplemental_Figures/PSTR_PhysCorrelations.png", width = 330, height = 225, units='mm', res = 300) 

corrgram(dip_corr_df, order=TRUE, lower.panel=panel.fill.R2, upper.panel=panel.pts.col, text.panel=panel.txt.brdr,
         col.regions=colorRampPalette(c("#ffffcc", "#c7e9b4", "#225ea8")), 
         color = dip_corr_df$colour, pch = as.numeric(as.character(dip_corr_df$shape)),
         labels = c("symbiont \ndensity", "host \nprotein", "chlorophyll a", "colour \nintensity", "calcification \nrate", "host \ncarbohydrate", "host \nlipid")) 

dev.off() 

```

```{r PAST correlation matrix and scatter plots, results='hide'}

## Create new correlation dataframe for SSID
por_corr_df <- a_df[,c(10:11,14:16,18,21:23)] %>% 
  mutate(shape = case_when(ftemp == "28" ~ "19",
                           ftemp == "31" ~ "21"),
         colour = case_when(fpco2 == "300" ~ "#b2abd2",
                            fpco2 == "420" ~ "#5e3c99",
                            fpco2 == "680" ~ "#fdb863",
                            fpco2 == "3300" ~ "#e66101"))
  

## Plot correlation matrix and scatter plot of all PAST physiology
png(file = "Figures/Supplemental_Figures/PAST_PhysCorrelations.png", width = 330, height = 225, units='mm', res = 300) 

corrgram(por_corr_df, order=TRUE, lower.panel=panel.fill.R2, upper.panel=panel.pts.col, text.panel=panel.txt.brdr,
         col.regions=colorRampPalette(c("#ffffcc", "#c7e9b4", "#225ea8")), 
         color = por_corr_df$colour, pch = as.numeric(as.character(por_corr_df$shape)),
         labels = c("symbiont \ndensity", "host \nprotein", "chlorophyll a", "colour \nintensity", "calcification \nrate", "host \ncarbohydrate", "host \nlipid")) 

dev.off() 

```

```{r save all species correlation/scatter plots, fig.width = 8, fig.height = 6.4}

ssid_corr_plot <- readPNG("Figures/Supplemental_Figures/SSID_PhysCorrelations.png")
pstr_corr_plot <- readPNG("Figures/Supplemental_Figures/PSTR_PhysCorrelations.png")
past_corr_plot <- readPNG("Figures/Supplemental_Figures/PAST_PhysCorrelations.png")

ssid_corr_plot <- ggplot() + 
  background_image(ssid_corr_plot) + 
  theme_void() + 
  ggtitle(expression(paste(bold("  A)   "), italic("S. siderea"))))

pstr_corr_plot <- ggplot() + 
  background_image(pstr_corr_plot) + 
  theme_void() + 
  ggtitle(expression(paste(bold("  B)   "), italic("P. strigosa"))))

past_corr_plot <- ggplot() + 
  background_image(past_corr_plot) + 
  theme_void() + 
  ggtitle(expression(paste(bold("  B)   "), italic("P. asteroides"))))

ggarrange(ssid_corr_plot, pstr_corr_plot, past_corr_plot, nrows = 2) +
  ggsave("Figures/Final_Figures/Figure2_PhysCorrelations.pdf", width = 8, height = 6.4)

```

**Figure 2.** Coral holobiont correlation matrices (bottom panel) and scatter plots (top panel) for *S. siderea* (**A**), *P. strigosa* (**B**), and *P. astreoides* (**C**) depicting pairwise comparisons of physiological parameters within each species. Strength of correlations between parameters is indicated by darker shades of blue in the bottom panel with a higher R^2^ value. Of these correlations, significant correlations are depicted with asterisks according to significance level (\* p < 0.05; \*\* p < 0.01; \*\*\* p < 0.001). Scatter plots of physiological parameters are displayed in the top panel with temperature depicted by shape (28$^\circ$C filled points; 31$^\circ$C open points) and *p*CO~2~ depicted by colour (280 $\mu$atm light purple; 400 $\mu$atm dark purple; 700 $\mu$atm light orange; 2800 $\mu$atm dark orange).

<br/>
<br/>


## Plasticity analyses {.tabset} 

#### *Methods:*
Using PC1 and PC2 for each species, we then calculated the phenotypic plasticity of each experimental fragment. Plasticity was calculated as the PC distance between an experimental fragment and the control (400 $\mu$atm; 28$^\circ$C) fragment from that same colony. 
All figures and statistical analyses were carried out in `r R.Version()$version.string` (R Core Development Team 2016).

<br/>

#### *Results:*
*Text for results of correlations will go here*

<br/>

### *Siderastrea siderea*

```{r SSID distance dataframe setup}

s_dis <- s_pca$x[,1:2] # grab PC1 and PC2 distances from prcomp() object
sid_dist <- cbind(s_df[,c(1,7,10,11,12,27)], s_dis) # combine the datasets

# adds column with the control value PC1/PC2 per colony
sid_dist$cont_pc1[sid_dist$treat2 == "447_28"] <- sid_dist$PC1[sid_dist$treat2 == "447_28"]
sid_dist$cont_pc2[sid_dist$treat2 == "447_28"] <- sid_dist$PC2[sid_dist$treat2 == "447_28"]

# get the 400_28 PC values
sid_dist2 <- sid_dist %>%  
  group_by(colony) %>% 
  summarise(con2_pc1 = sum(cont_pc1, na.rm = TRUE),
            con2_pc2 = sum(cont_pc2, na.rm = TRUE))

# Make columns of the 400_28 PC values
sid_dist <- sid_dist %>% 
  left_join(sid_dist2, by = c("colony" = "colony"))

sid_dist$dist <- sqrt(((sid_dist$PC1 - sid_dist$con2_pc1)^2) + ((sid_dist$PC2 - sid_dist$con2_pc2)^2)) # formula for calculating distance between control (T90) and treatment values
sid_dist$treat_plot = paste(sid_dist$fpco2, sid_dist$ftemp, sep = "_")


## modify dataframe to remove the control treatment and reorder levels
sid_dist <- sid_dist %>% 
  filter(treat_plot != "420_28") %>% 
  mutate(treat_plot = factor(treat_plot, levels = c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31")))

```

```{r SSID distance analysis, include=FALSE}

## Model selection (via AIC)
ssid_dist_mod <- glm(dist ~ reef * fpco2 * ftemp, family = Gamma(link = "log"), data = sid_dist)
ssid_dist_mod2 <- glm(dist ~ reef * fpco2 + ftemp, family = Gamma(link = "log"), data = sid_dist) # best fit
ssid_dist_mod3 <- glm(dist ~ reef + fpco2 * ftemp, family = Gamma(link = "log"), data = sid_dist)
ssid_dist_mod4 <- glm(dist ~ reef + fpco2 + ftemp, family = Gamma(link = "log"), data = sid_dist)
ssid_dist_mod5 <- glm(dist ~ reef * (fpco2 + ftemp), family = Gamma(link = "log"), data = sid_dist)
ssid_dist_mod6 <- glm(dist ~ fpco2 + ftemp, family = Gamma(link = "log"), data = sid_dist)

# check for best-fit model
compare_performance(ssid_dist_mod, ssid_dist_mod2, ssid_dist_mod3, ssid_dist_mod4, ssid_dist_mod5, ssid_dist_mod6, rank = TRUE)
plot(compare_performance(ssid_dist_mod, ssid_dist_mod2, ssid_dist_mod3, ssid_dist_mod4, ssid_dist_mod5, ssid_dist_mod6, rank = TRUE))


## Best-fit GLM with Gamma log link
ssid_dist_glm <- glm(dist ~ reef * fpco2 + ftemp, family = Gamma(link = "log"), data = sid_dist)
summary(ssid_dist_glm)


## Bootstrapping with boot_predict() function in package finalfit (version 1.0.2)
newdata_ssid <- data.frame(reef = sid_dist$reef, fpco2 = sid_dist$fpco2, ftemp = sid_dist$ftemp, treat_plot = sid_dist$treat_plot, dist = sid_dist$dist)

ssid_dist_boot <- boot_predict(ssid_dist_glm, newdata = newdata_ssid, R = bootnum, boot_compare = FALSE,  estimate_name = "Predicted plasticity") %>% # compute boot predictions
  mutate(plasticity = as.character(`Predicted plasticity`), # create second predicted column for plotting
         plasticity = gsub("[()to]", "", plasticity)) %>% # remove characters
  separate(plasticity, c("estimate", "lowerci", "rm", "upperci"), " ") %>% # separate into three columns for estimate, lower CI, and upper CI
  dplyr::select(-rm) %>% # remove the blank column created
  mutate_if(is.character, as.numeric) # convert the esimate/CI from character to numeric
  
```

```{r plots of SSID distances, fig.height = 3.5, fig.width = 6}

## Summary data for plotting based on mean/SE instead of boot
sid_dist_sum <- sid_dist %>% 
  mutate(treat_plot = factor(treat_plot, levels = c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31"))) %>% 
  group_by(treat_plot, reef) %>% 
  summarise(mean = mean(dist),
            se = (sd(dist) / sqrt(n()))) 


## Plasticity plot
ssid_plast_plot <- ggplot(ssid_dist_boot, aes(x = reef, y = estimate, colour = treat_plot, fill = treat_plot, shape = treat_plot)) +
  theme_pubr() +
  theme(legend.title = element_blank(), axis.ticks.x = element_blank()) +
  guides(shape = guide_legend(ncol = 1), fill = guide_legend(override.aes = list(linetype = 0)), color = guide_legend(override.aes = list(linetype = 0))) +
  geom_point(aes(x = reef, y = dist), size = 2, alpha = 0.7, position = position_dodge(width = 0.55)) +
  geom_errorbar(aes(ymin = lowerci, ymax = upperci), alpha = 0.8, size = 1, width = 0, position = position_dodge(width = 0.55)) +
  geom_point(size = 3, stroke = 1, position = position_dodge(width = 0.55)) +
  scale_shape_manual(values = c(21, 21, 23, 24, 24, 22, 22)) +
  scale_colour_manual(values = c("#b2abd2", "#b2abd2", "#5e3c99", "#fdb863", "#fdb863", "#e66101", "#e66101")) + 
  scale_fill_manual(values = c("#b2abd2", "white", "white", "#fdb863", "white", "#e66101", "white")) + 
  labs(y = "PC distance from control", x = "") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 8)) +
  scale_x_discrete(labels = c("F" = "Offshore", "N" = "Inshore"))
  

## Linear model output
summary(ssid_dist_glm)

```

### *Pseudodiploria strigosa*

```{r PSTR distance dataframe setup}

p_dis <- p_pca$x[,1:2] # grab PC1 and PC2 distances from prcomp() object
dip_dist <- cbind(p_df[,c(1,7,10,11,12,27)], p_dis) # combine the datasets

# adds column with the control value PC1/PC2 per colony
dip_dist$cont_pc1[dip_dist$treat2 == "447_28"] <- dip_dist$PC1[dip_dist$treat2 == "447_28"]
dip_dist$cont_pc2[dip_dist$treat2 == "447_28"] <- dip_dist$PC2[dip_dist$treat2 == "447_28"]

# get the 400_28 PC values
dip_dist2 <- dip_dist %>%  
  group_by(colony) %>% 
  summarise(con2_pc1 = sum(cont_pc1, na.rm = TRUE),
            con2_pc2 = sum(cont_pc2, na.rm = TRUE))

# Make columns of the 400_28 PC values
dip_dist <- dip_dist %>% 
  left_join(dip_dist2, by = c("colony" = "colony"))

dip_dist$dist <- sqrt(((dip_dist$PC1 - dip_dist$con2_pc1)^2) + ((dip_dist$PC2 - dip_dist$con2_pc2)^2)) # formula for 
dip_dist$treat_plot = paste(dip_dist$fpco2, dip_dist$ftemp, sep = "_")


## modify dataframe to remove the control treatment and reorder levels
dip_dist <- dip_dist %>% 
  filter(treat_plot != "420_28")%>% 
  mutate(treat_plot = factor(treat_plot, levels = c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31")))

```

```{r PSTR distance analysis, include=FALSE}

## Model selection (via AIC)
pstr_dist_mod <- glm(dist ~ reef * fpco2 * ftemp, family = Gamma(link = "log"), data = dip_dist)
pstr_dist_mod2 <- glm(dist ~ reef * fpco2 + ftemp, family = Gamma(link = "log"), data = dip_dist)
pstr_dist_mod3 <- glm(dist ~ reef + fpco2 * ftemp, family = Gamma(link = "log"), data = dip_dist) # best fit
pstr_dist_mod4 <- glm(dist ~ reef + fpco2 + ftemp, family = Gamma(link = "log"), data = dip_dist)
pstr_dist_mod5 <- glm(dist ~ reef * (fpco2 + ftemp), family = Gamma(link = "log"), data = dip_dist)
pstr_dist_mod6 <- glm(dist ~ fpco2 + ftemp, family = Gamma(link = "log"), data = dip_dist)

# check for best-fit model
compare_performance(pstr_dist_mod, pstr_dist_mod2, pstr_dist_mod3, pstr_dist_mod4, pstr_dist_mod5, pstr_dist_mod6, rank = TRUE)
plot(compare_performance(pstr_dist_mod, pstr_dist_mod2, pstr_dist_mod3, pstr_dist_mod4, pstr_dist_mod5, pstr_dist_mod6, rank = TRUE))


## Best-fit GLM with Gamma log link
pstr_dist_glm <- glm(dist ~ reef + fpco2 * ftemp, family = Gamma(link = "log"), data = dip_dist)
summary(pstr_dist_glm)


## Bootstrapping with boot_predict() function in package finalfit (version 1.0.2)
newdata_pstr <- data.frame(reef = dip_dist$reef, fpco2 = dip_dist$fpco2, ftemp = dip_dist$ftemp, treat_plot = dip_dist$treat_plot, dist = dip_dist$dist)

pstr_dist_boot <- boot_predict(pstr_dist_glm, newdata = newdata_pstr, R = bootnum, boot_compare = FALSE,  estimate_name = "Predicted plasticity") %>% # compute boot predictions
  mutate(plasticity = as.character(`Predicted plasticity`), # create second predicted column for plotting
         plasticity = gsub("[()to]", "", plasticity)) %>% # remove characters
  separate(plasticity, c("estimate", "lowerci", "rm", "upperci"), " ") %>% # separate into three columns for estimate, lower CI, and upper CI
  dplyr::select(-rm) %>% # remove the blank column created
  mutate_if(is.character, as.numeric) # convert the esimate/CI from character to numeric

```
  
```{r plots of PSTR distances, fig.height = 3.5, fig.width = 6}

## Summary data for plotting
dip_dist_sum <- dip_dist %>% 
  mutate(treat_plot = factor(treat_plot, levels = c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31"))) %>% 
  group_by(treat_plot, reef) %>% 
  summarise(mean = mean(dist),
            se = (sd(dist) / sqrt(n()))) 


## Plasticity plot
pstr_plast_plot <- ggplot(dip_dist_sum, aes(x = reef, y = mean, colour = treat_plot, fill = treat_plot, shape = treat_plot)) +
  theme_pubr() +
  theme(legend.title = element_blank(), axis.ticks.x = element_blank()) +
  guides(shape = guide_legend(ncol = 1), fill = guide_legend(override.aes = list(linetype = 0)), color = guide_legend(override.aes = list(linetype = 0))) +
  geom_point(data = dip_dist, aes(x = reef, y = dist), size = 2, alpha = 0.7, position = position_dodge(width = 0.55)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), alpha = 0.8, size = 1, width = 0, position = position_dodge(width = 0.55)) +
  geom_point(size = 3, stroke = 1, position = position_dodge(width = 0.55)) +
  scale_shape_manual(values = c(21, 21, 23, 24, 24, 22, 22)) +
  scale_colour_manual(values = c("#b2abd2", "#b2abd2", "#5e3c99", "#fdb863", "#fdb863", "#e66101", "#e66101")) + 
  scale_fill_manual(values = c("#b2abd2", "white", "white", "#fdb863", "white", "#e66101", "white")) + 
  labs(y = "", x = "") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 8)) +
  scale_x_discrete(labels = c("F" = "Offshore", "N" = "Inshore"))


## Linear model output
summary(pstr_dist_glm)

```

### *Porites astreoides*

```{r PAST distance dataframe setup}

a_dis <- a_pca$x[,1:2] # grab PC1 and PC2 distances from prcomp() object
por_dist <- cbind(a_df[,c(1,7,10,11,12,27)], a_dis) # combine the datasets

# adds column with the control value PC1/PC2 per colony
por_dist$cont_pc1[por_dist$treat2 == "447_28"] <- por_dist$PC1[por_dist$treat2 == "447_28"]
por_dist$cont_pc2[por_dist$treat2 == "447_28"] <- por_dist$PC2[por_dist$treat2 == "447_28"]

# get the 400_28 PC values
por_dist2 <- por_dist %>%  
  group_by(colony) %>% 
  summarise(con2_pc1 = sum(cont_pc1, na.rm = TRUE),
            con2_pc2 = sum(cont_pc2, na.rm = TRUE))

# Make columns of the 400_28 PC values
por_dist <- por_dist %>% 
  left_join(por_dist2, by = c("colony" = "colony"))

por_dist$dist <- sqrt(((por_dist$PC1 - por_dist$con2_pc1)^2) + ((por_dist$PC2 - por_dist$con2_pc2)^2)) # formula for calculating distance between control (T90) and treatment values
por_dist$treat_plot = paste(por_dist$fpco2, por_dist$ftemp, sep = "_")

## modify dataframe to remove the control treatment and reorder levels
por_dist <- por_dist %>% 
  filter(treat_plot != "420_28")%>% 
  mutate(treat_plot = factor(treat_plot, levels = c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31")))

```

```{r PAST distance analysis, include=FALSE}

## Model selection (via AIC)
past_dist_mod <- glm(dist ~ reef * fpco2 * ftemp, family = Gamma(link = "log"), data = por_dist)
past_dist_mod2 <- glm(dist ~ reef * fpco2 + ftemp, family = Gamma(link = "log"), data = por_dist)
past_dist_mod3 <- glm(dist ~ reef + fpco2 * ftemp, family = Gamma(link = "log"), data = por_dist)
past_dist_mod4 <- glm(dist ~ reef + fpco2 + ftemp, family = Gamma(link = "log"), data = por_dist)
past_dist_mod5 <- glm(dist ~ reef * (fpco2 + ftemp), family = Gamma(link = "log"), data = por_dist)
past_dist_mod6 <- glm(dist ~ fpco2 + ftemp, family = Gamma(link = "log"), data = por_dist) # best fit

# check for best-fit model
compare_performance(past_dist_mod, past_dist_mod2, past_dist_mod3, past_dist_mod4, past_dist_mod5, past_dist_mod6, rank = TRUE)
plot(compare_performance(past_dist_mod, past_dist_mod2, past_dist_mod3, past_dist_mod4, past_dist_mod5, past_dist_mod6, rank = TRUE))


## Best-fit GLM with Gamma log link
past_dist_glm <- glm(dist ~ fpco2 + ftemp, family = Gamma(link = "log"), data = por_dist)
summary(past_dist_glm)

```
  
```{r plots of PAST distances, fig.height = 3, fig.width = 10}

## Summary data for plotting
por_dist_sum <- por_dist %>% 
  mutate(treat_plot = factor(treat_plot, levels = c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31"))) %>% 
  group_by(treat_plot, reef) %>% 
  summarise(mean = mean(dist),
            se = (sd(dist) / sqrt(n()))) 


## Plasticity plot
past_plast_plot <- ggplot(por_dist_sum, aes(x = reef, y = mean, colour = treat_plot, fill = treat_plot, shape = treat_plot)) +
  theme_pubr() +
  theme(legend.title = element_blank(), axis.ticks.x = element_blank()) +
  guides(shape = guide_legend(ncol = 1), fill = guide_legend(override.aes = list(linetype = 0)), color = guide_legend(override.aes = list(linetype = 0))) +
  geom_point(data = por_dist, aes(x = reef, y = dist), size = 2, alpha = 0.7, position = position_dodge(width = 0.55)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), alpha = 0.8, size = 1, width = 0, position = position_dodge(width = 0.55)) +
  geom_point(size = 3, stroke = 1, position = position_dodge(width = 0.55)) +
  scale_shape_manual(values = c(21, 21, 23, 24, 24, 22, 22)) +
  scale_colour_manual(values = c("#b2abd2", "#b2abd2", "#5e3c99", "#fdb863", "#fdb863", "#e66101", "#e66101")) + 
  scale_fill_manual(values = c("#b2abd2", "white", "white", "#fdb863", "white", "#e66101", "white")) + 
  labs(y = "", x = "") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 8)) +
  scale_x_discrete(labels = c("F" = "Offshore", "N" = "Inshore"))


## Linear model output
summary(past_dist_glm)

```

### **Figure 3**

```{r plot and save all species plasticity, fig.width = 13, fig.height = 4}

ggarrange(ssid_plast_plot, pstr_plast_plot, past_plast_plot, common.legend = TRUE, legend = "right", ncol = 3) +
  ggsave("Figures/Final_Figures/Figure3_PhysPlasticity.pdf", width = 13, height = 4)

```

**Figure 3.** Assessment of phenotypic plasticity of *S. siderea* (**A**), *P. strigosa* (**B**), and *P. astreoides* (**C**) in experimental treatments and by natal reef environment. Higher values represent greater plasticity in coral holobiont samples. *p*CO~2~ treatment is depicted by colour and shape (280 $\mu$atm light purple, circle; 400 $\mu$atm dark purple, diamond; 700 $\mu$atm light orange, triangle; 2800 $\mu$atm dark orange, square) and temperature is represented as either filled (28$^\circ$C) or open (31$^\circ$C) symbols.

<br/>
<br/>


## Physiological paramters {.tabset}

Physiological response parameters were assessed using mixed-effects linear models across species and treatments. Model selection was carried out using backward elimination of random-effects followed by fixed-effects using the package [*lmerTest*](https://cran.r-project.org/web/packages/lmerTest/lmerTest.pdf) (version `r packageVersion("lmerTest")`)

```{r T0 model selection, eval=FALSE, include=FALSE}

### Planning to model all measured values in response to parameter and species

## subsetting for T0 only
df_T0 <- subset(df2, T0_T90=="T0") # subset the dataframe for only T0 samples
df_T0 <- completeFun(df_T0, "value") # run function to remove any missing values


## running forloop to model each T0 CI per species in each parameter
param_list <- levels(factor(df_T0$param)) # create a list of parameter names

for (p in 1:length(param_list)) {
  
  # subset T0 dataframe by selected param name
  param_name <- param_list[p]
  T0_df_sub <- subset(df_T0, param == param_name)
  
  # run linear model 
  model <- lm(value ~ species, data = T0_df_sub) 
  out <- simulate(model, nsim = bootnum, seed = seed, re.form = NULL) # simulate model response 2000 (bootnum)   times
  boots <- apply(out, 2, function(x) predict(lm(x ~ species, data = T0_df_sub), re.form=NA)) #   applies predict function on the columns (2) of the 'out' matrix created above from simulating the model 
  boots <- cbind(predict(model, re.form = NA), boots) # adds column to above df of predicted values without   random effects
  df_T0_a <- (cbind(T0_df_sub, as.data.frame(t(apply(boots, 1, function(x) c(mean(x), quantile(x, c(0.025, 0.975)))))))) #   apply function to calculate mean and 95% CI per sample based on the bootstrapped values, then add these to the actual   values dataframe
  colnames(df_T0_a)[17:19] <- c("mean", "lowerci", "upperci") # rename columns with bootstrapped values
  
  ## save model results
  T0_df <- paste("LMER_model_outputs/T0_models/T0_model", param_name, date, sep="_") 
  T0_df <- paste(T0_df, ".csv", sep="") 
  write.csv(df_T0_a, file = T0_df)  # last saved model was: 2020-11-11
  
}



## read in all T0 model files and merge into single file
files <- fs::dir_ls(glob = "*csv", path = "LMER_model_outputs/T0_models/")
mergedT0 <- vroom(files)
write.csv(mergedT0, file = paste("LMER_model_outputs/T0_combined_out_", date, ".csv", sep=""))  # last saved model was: 2020-11-11

```

```{r T0 dataframe subsetting}

df_T0 <- read.csv("LMER_model_outputs/T0_combined_out_2020-11-12.csv", head = TRUE)

# make a list of parameter names
param_list <- levels(df_T0$param)

# forloop for dataframes
for (p in 1:length(param_list)) {
  param_select <- param_list[p]
  df_subset <- subset(df_T0, param == param_select) # subset the dataframe for only one parameter
  df_subset <- completeFun(df_subset, "value") # run function to remove any missing values
  df_subset$value <- as.numeric(df_subset$value)
  assign(paste("df_T0", param_select, sep = "_"), df_subset) # assign the data to dataframe named for each parameter 
}

```

```{r model fitting, eval=FALSE, include=FALSE}

param_df_list <- lapply(ls(pattern = "mod_df"), function(x) get(x))
model_plot_list <- NULL

for (p in 1:length(param_list)) {
  
  df <- param_df_list[[p]]
  param_list <- sort(param_list)
  param_select <- param_list[p]

  if (df[1,15] == "count") {
    glm_full <- glmer.nb(value ~ species * fpco2 * ftemp * reef + offset(log(offset)) + (1 | colony), data = df)
    glm_add <- glmer.nb(value ~ species + fpco2 + ftemp + reef + offset(log(offset)) + (1 | colony), data = df)
    glm_base <- glmer.nb(value ~ species * (fpco2 + ftemp) + reef + offset(log(offset)) + (1 | colony), data = df)
  } else if (df[1,15] == "chla") {
    glm_full <- glmer(value ~ species * fpco2 * ftemp * reef + (1 | colony), family = Gamma(link = "log"), data = df)
    glm_add <- glmer(value ~ species + fpco2 + ftemp + reef + (1 | colony), family = Gamma(link = "log"), data = df)
    glm_base <- glmer(value ~ species * (fpco2 + ftemp) + (1 | colony), family = Gamma(link = "log"), data = df)
    } else {
    glm_full <- glmer(value ~ species * fpco2 * ftemp * reef + (1 | colony), family = Gamma, data = df)
    glm_add <- glmer(value ~ species + fpco2 + ftemp + reef + (1 | colony), family = Gamma, data = df)
    glm_base <- glmer(value ~ species * (fpco2 + ftemp) + (1 | colony), family = Gamma, data = df)
  }
  
  model_compare_table <- compare_performance(glm_full, glm_add, glm_base, rank = TRUE)
  assign(paste(param_select, "mod_table", sep = "_"), model_compare_table) # assign the data to dataframe named for each parameter 
  model_plot_list[[p]] <- plot(model_compare_table)
  
}



summary(g1 <- glmer.nb(value ~ species * fpco2 * ftemp * reef + offset(log(offset)) + (1 | colony), data = df))
  

# Protein: proceeding with the base model with a gamma distribution

```

#### Protein 

```{r protein model selection, include=FALSE}

## run the full mixed-effects model for backwards removal of non-significant effects (using lmerTest version 3.1-3)
pro_full_model <- lmer(value ~ species * fpco2 * ftemp * reef + (1 | colony), data = pro_mod_df) # full model
pro_step <- step(pro_full_model) # run removal for best-fit model
pro_mod <- get_model(pro_step) # pull the final model
pro_mod_bestfit <- pro_mod@call[["formula"]] # pulls the model output
pro_mod_bestfit <- paste(format(pro_mod_bestfit))
anova(pro_mod) # run anova on best fit model 

```

While *`r pro_mod_bestfit`* was the best-fit model structure identified, we wanted to model both *p*CO~2~ and temperature responses by species so moving forward we are using the following model structure: 

**value ~ species * (fpco2 + ftemp) + (1 | colony)**


```{r protein bootstrapping, eval=FALSE}

## mixed effect model run using lmer() (lmerTest version 3.1-3)
T90_df_model <- lmer(value ~ species + fpco2 + ftemp + (1 | colony) + species:ftemp, REML = TRUE, data = pro_mod_df)
out <- simulate(T90_df_model, nsim = bootnum, seed = seed, re.form = NULL) # simulate model protein response 2000 (bootnum) times (using random effects)
boots <- apply(out, 2, function(x) predict(lmer(x ~ species + fpco2 + ftemp + (1 | colony) + species:ftemp, REML = TRUE, data = pro_mod_df), re.form=NA)) # applies predict function on the columns (2) of the 'out' matrix created above from simulating the model 
boots <- cbind(predict(T90_df_model, re.form = NA), boots) # adds column to above df of predicted protein values without random effects
pro_mod_df_a <- (cbind(pro_mod_df, as.data.frame(t(apply(boots, 1, function(x) c(mean(x), quantile(x, c(0.025, 0.975)))))))) # apply function to calculate mean and 95% CI per sample based on the bootstrapped values, then add these to the actual values dataframe
colnames(pro_mod_df_a)[17:19] <- c("mean", "lowerci", "upperci") # rename columns with bootstrapped values

pro_df <- paste("LMER_model_outputs/Protein_model", date, sep="_") 
pro_df <- paste(pro_df, ".csv", sep="") 
write.csv(pro_mod_df_a, file = pro_mod_df_a)  # last saved model was: 2020-11-12

```

<br/>
Figure:

```{r protein figure, fig.height = 2, fig.width = 10, fig.align = "center", results = 'hide', message=FALSE}

## load the protein bootstrapped model output
df_pro_a <- read.csv("LMER_model_outputs/Protein_model_2021-03-24.csv", head = TRUE)
df_pro_a$ftemp <- as.factor(df_pro_a$ftemp)
df_pro_a$fpco2 <- as.factor(df_pro_a$fpco2)
df_pro_a$species <- factor(df_pro_a$species, levels = c("SSID", "PSTR", "PAST", "UTEN"))

## plot figure
pro_model_fig <- ggplot(df_pro_a)+
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), strip.text.x = element_blank(), panel.background=element_blank(), axis.line=element_line(color="black"), legend.key=element_blank(), strip.background = element_blank(), legend.position="none", panel.border = element_rect(colour = "black", size= 0.8))+
  scale_x_continuous(breaks = c(2, 4 ,6 ,8, 10), labels = c("T0", "300", "420", "680", "3300"))+
  geom_vline(xintercept = 3, size= 0.8) +
  ylab(plab)+
  xlab("")+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2)+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2, data = df_T0_pro) + # add T0 samples
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci, colour = ftemp), position = dodge, size = 1)+
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci), colour = "#009E73", position = dodge, size = 1, data = df_T0_pro)+ # add T0 CIs
  scale_color_manual("Temperature", values = c("#0072B2", "#D55E00", "#009E73"))+
  facet_wrap(~species, ncol = 3, scales = "free_y") +
  ggsave(paste0("Figures/Supplemental_Figures/Protein_boot_figure.pdf"), width = 10, height = 3)
pro_model_fig

```


#### Carbohydrate 

```{r carbohydrate model selection, include=FALSE}

## run the full mixed-effects model for backwards removal of non-significant effects (using lmerTest version 3.1-3)
carb_full_model <- lmer(value ~ species * fpco2 * ftemp * reef + (1 | colony) + (1 | reef), data = carb_mod_df) # full model
carb_step <- step(carb_full_model) # run removal for best-fit model
carb_mod <- get_model(carb_step) # pull the final model
carb_mod_bestfit <- carb_mod[["call"]][["formula"]] # pulls the model output
carb_mod_bestfit <- paste(format(carb_mod_bestfit))
carb_mod_bestfit <- paste0(carb_mod_bestfit[1])
anova(carb_mod) # run anova on best fit model 

```

While *`r carb_mod_bestfit`* was the best-fit model structure identified, we wanted to model responses with a random effect of colony so moving forward we are using the following model structure: 

**value ~ species * (fpco2 + ftemp) + (1 | colony)**


```{r carbohydrate bootstrapping, eval=FALSE}

## mixed effect model run using lmer() (lmerTest version 3.1-3)
T90_df_model <- lmer(value ~ species * (fpco2 + ftemp) + (1 | colony), REML = TRUE, data = carb_mod_df)
out <- simulate(T90_df_model, nsim = bootnum, seed = seed, re.form = NULL) # simulate model carbohydrate response 2000 (bootnum) times (using random effects)
boots <- apply(out, 2, function(x) predict(lmer(x ~ species * (fpco2 + ftemp) + (1 | colony), REML = TRUE, data = carb_mod_df), re.form=NA)) # applies predict function on the columns (2) of the 'out' matrix created above from simulating the model 
boots <- cbind(predict(T90_df_model, re.form = NA), boots) # adds column to above df of predicted carbohydrate values without random effects
carb_mod_df_a <- (cbind(df_carb, as.data.frame(t(apply(boots, 1, function(x) c(mean(x), quantile(x, c(0.025, 0.975)))))))) # apply function to calculate mean and 95% CI per sample based on the bootstrapped values, then add these to the actual values dataframe
colnames(carb_mod_df_a)[17:19] <- c("mean", "lowerci", "upperci") # rename columns with bootstrapped values

carb_df <- paste("LMER_model_outputs/Carbohydrate_model", date, sep="_") 
carb_df <- paste(carb_df, ".csv", sep="") 
write.csv(carb_mod_df_a, file = carb_df)  # last saved model was: 020-11-12

```

<br/>
Figure:

```{r carbohydrate figure, fig.height = 2, fig.width = 10, fig.align = "center", results = 'hide', message=FALSE}

## load the carbohydrate bootstrapped model output
df_carb_a <- read.csv("LMER_model_outputs/Carbohydrate_model_2020-11-12.csv", head=T)
df_carb_a$ftemp <- as.factor(df_carb_a$ftemp)
df_carb_a$fpco2 <- as.factor(df_carb_a$fpco2)
df_carb_a$species <- factor(df_carb_a$species, levels = c("SSID", "PSTR", "PAST", "UTEN"))

## plot figure
carb_model_fig <- ggplot(df_carb_a)+
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), strip.text.x = element_blank(), panel.background=element_blank(), axis.line=element_line(color="black"), legend.key=element_blank(), strip.background = element_blank(), legend.position="none", panel.border = element_rect(colour = "black", size= 0.8))+
  scale_x_continuous(breaks = c(2, 4 ,6 ,8, 10), labels = c("T0", "300", "420", "680", "3300"))+
  geom_vline(xintercept = 3, size= 0.8)+
  ylab(calab)+
  xlab("")+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2)+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2, data = df_T0_carb) + # add T0 samples
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci, colour = ftemp), position = dodge, size = 1)+
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci), colour = "#009E73", position = dodge, size = 1, data = df_T0_carb)+ # add T0 CIs
  scale_color_manual("Temperature", values = c("#0072B2", "#D55E00", "#009E73"))+
  facet_wrap(~species, ncol = 3, scales = "free_y") +
  ggsave(paste0("Figures/Supplemental_Figures/Carbohydrate_boot_figure.pdf"), width = 10, height = 3)
carb_model_fig

```


#### Lipid 

```{r lipid model selection, include=FALSE}

## run the full mixed-effects model for backwards removal of non-significant effects (using lmerTest version 3.1-3)
lipid_full_model <- lmer(value ~ species * fpco2 * ftemp * reef + (1 | colony) + (1 | reef), data = lipid_mod_df) # full model
lipid_step <- step(lipid_full_model) # run removal for best-fit model
lipid_mod <- get_model(lipid_step) # pull the final model
lipid_mod_bestfit <- lipid_mod[["call"]][["formula"]] # pulls the model output 
lipid_mod_bestfit <- paste(format(lipid_mod_bestfit))
anova(lipid_mod) # run anova on best fit model 

```

While *`r lipid_mod_bestfit`* was the best-fit model structure identified, we wanted to model both *p*CO~2~ and temperature responses by species and with random effect of colony so moving forward we are using the following model structure: 

**value ~ species * (fpco2 + ftemp) + reef + species:reef + (1 | colony)**

```{r lipid bootstrapping, eval=FALSE}

## mixed effect model run using lmer() (lmerTest version 3.1-3)
T90_df_model <- lmer(value ~ species + ftemp + reef + species:ftemp + species:reef + (1|colony), REML = TRUE, data = lipid_mod_df)
out <- simulate(T90_df_model, nsim = bootnum, seed = seed, re.form = NULL) # simulate model lipid response 2000 (bootnum) times (using random effects)
boots <- apply(out, 2, function(x) predict(lmer(x ~ species + ftemp + reef + species:ftemp + species:reef + (1|colony), REML = TRUE, data = lipid_mod_df), re.form=NA)) # applies predict function on the columns (2) of the 'out' matrix created above from simulating the model 
boots <- cbind(predict(T90_df_model, re.form = NA), boots) # adds column to above df of predicted lipid values without random effects
lipid_mod_df_a <- (cbind(lipid_mod_df, as.data.frame(t(apply(boots, 1, function(x) c(mean(x), quantile(x, c(0.025, 0.975)))))))) # apply function to calculate mean and 95% CI per sample based on the bootstrapped values, then add these to the actual values dataframe
colnames(lipid_mod_df_a)[17:19] <- c("mean", "lowerci", "upperci") # rename columns with bootstrapped values

lipid_df <- paste("LMER_model_outputs/Lipid_model", date, sep="_") 
lipid_df <- paste(lipid_df, ".csv", sep="") 
write.csv(lipid_mod_df_a, file = lipid_df)  # last saved model was: 2020-11-12

```

<br/>
Figure:

```{r lipid figure, fig.height = 2, fig.width = 10, fig.align = "center", results = 'hide', message=FALSE}

## load the lipid bootstrapped model output
df_lipid_a <- read.csv("LMER_model_outputs/Lipid_model_2021-03-24.csv", head=T)
df_lipid_a$ftemp <- as.factor(df_lipid_a$ftemp)
df_lipid_a$fpco2 <- as.factor(df_lipid_a$fpco2)
df_lipid_a$species <- factor(df_lipid_a$species, levels = c("SSID", "PSTR", "PAST", "UTEN"))

## plot figure
lipid_model_fig <- ggplot(df_lipid_a)+
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), strip.text.x = element_blank(), panel.background=element_blank(), axis.line=element_line(color="black"), legend.key=element_blank(), strip.background = element_blank(), legend.position="none", panel.border = element_rect(colour = "black", size= 0.8))+
  scale_x_continuous(breaks = c(2, 4 ,6 ,8, 10), labels = c("T0", "300", "420", "680", "3300"))+
  geom_vline(xintercept = 3, size= 0.8)+
  ylab(llab)+
  xlab("")+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2)+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2, data = df_T0_lipid) + # add T0 samples
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci, colour = ftemp), position = dodge, size = 1)+
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci), colour = "#009E73", position = dodge, size = 1, data = df_T0_lipid)+ # add T0 CIs
  scale_color_manual("Temperature", values = c("#0072B2", "#D55E00", "#009E73"))+
  facet_wrap(~species, ncol = 3, scales = "free_y") +
  ggsave(paste0("Figures/Supplemental_Figures/Lipid_boot_figure.pdf"), width = 10, height = 3)
lipid_model_fig

```


#### Density 

```{r density model selection, include=FALSE}

## run the full mixed-effects model for backwards removal of non-significant effects (using lmerTest version 3.1-3)
den_full_model <- lmer(value ~ species * fpco2 * ftemp * reef + (1 | colony) + (1 | reef), data = den_mod_df) # full model
den_step <- step(den_full_model) # run removal for best-fit model
den_mod <- get_model(den_step) # pull the final model
den_mod_bestfit <- den_mod@call[["formula"]] # pulls the model output
den_mod_bestfit <- paste(format(den_mod_bestfit))
den_mod_bestfit <- paste0(den_mod_bestfit[1], den_mod_bestfit[2], den_mod_bestfit[3], den_mod_bestfit[4])
anova(den_mod) # run anova on best fit model 

```

While *`r den_mod_bestfit`* was the best-fit model structure identified, we wanted to model both *p*CO~2~ and temperature responses by species and with random effect of colony so moving forward we are using the following model structure: 

**value ~ species * (fpco2 + ftemp) + reef + species:reef + (1 | colony)**


```{r density bootstrapping, eval=FALSE}

## mixed effect model run using lmer() (lmerTest version 3.1-3)
T90_df_model <- lmer(value ~ species + fpco2 + ftemp + reef + (1 | colony) + species:fpco2 + species:ftemp + fpco2:ftemp + species:reef + fpco2:reef + ftemp:reef + species:fpco2:ftemp + species:fpco2:reef + species:ftemp:reef + fpco2:ftemp:reef + species:fpco2:ftemp:reef, REML = TRUE, data = den_mod_df)
out <- simulate(T90_df_model, nsim = bootnum, seed = seed, re.form = NULL) # simulate model density response 2000 (bootnum) times (using random effects)
boots <- apply(out, 2, function(x) predict(lmer(x ~ species + fpco2 + ftemp + reef + (1 | colony) + species:fpco2 + species:ftemp + fpco2:ftemp + species:reef + fpco2:reef + ftemp:reef + species:fpco2:ftemp + species:fpco2:reef + species:ftemp:reef + fpco2:ftemp:reef + species:fpco2:ftemp:reef, REML = TRUE, data = den_mod_df), re.form=NA)) # applies predict function on the columns (2) of the 'out' matrix created above from simulating the model 
boots <- cbind(predict(T90_df_model, re.form = NA), boots) # adds column to above df of predicted density values without random effects
den_mod_df_a <- (cbind(den_mod_df, as.data.frame(t(apply(boots, 1, function(x) c(mean(x), quantile(x, c(0.025, 0.975)))))))) # apply function to calculate mean and 95% CI per sample based on the bootstrapped values, then add these to the actual values dataframe
colnames(den_mod_df_a)[17:19] <- c("mean", "lowerci", "upperci") # rename columns with bootstrapped values

den_df <- paste("LMER_model_outputs/Density_model", date, sep="_") 
den_df <- paste(den_df, ".csv", sep="") 
write.csv(den_mod_df_a, file = den_df)  # last saved model was: Density_model_2020-11-05.csv

```

<br/>
Figure:

```{r density figure, fig.height = 2, fig.width = 10, fig.align = "center", results = 'hide', message=FALSE}

## load the density bootstrapped model output
df_den_a <- read.csv("LMER_model_outputs/Density_model_2020-11-12.csv", head=T)
df_den_a$ftemp <- as.factor(df_den_a$ftemp)
df_den_a$fpco2 <- as.factor(df_den_a$fpco2)
df_den_a$species <- factor(df_den_a$species, levels = c("SSID", "PSTR", "PAST", "UTEN"))

## plot figure
den_model_fig <- ggplot(df_den_a)+
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), strip.text.x = element_blank(), panel.background=element_blank(), axis.line=element_line(color="black"), legend.key=element_blank(), strip.background = element_blank(), legend.position="none", panel.border = element_rect(colour = "black", size= 0.8))+
  scale_x_continuous(breaks = c(2, 4 ,6 ,8, 10), labels = c("T0", "300", "420", "680", "3300"))+
  geom_vline(xintercept = 3, size= 0.8)+
  ylab(dlab)+
  xlab("")+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2)+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2, data = df_T0_den) + # add T0 samples
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci, colour = ftemp), position = dodge, size = 1)+
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci), colour = "#009E73", position = dodge, size = 1, data = df_T0_den)+ # add T0 CIs
  scale_color_manual("Temperature", values = c("#0072B2", "#D55E00", "#009E73"))+
  facet_wrap(~species, ncol = 3, scales = "free_y") +
  ggsave(paste0("Figures/Supplemental_Figures/Density_boot_figure.pdf"), width = 10, height = 3)
den_model_fig

```


#### Chlorophyll 

```{r chlorophyll model selection, include=FALSE}

## run the full mixed-effects model for backwards removal of non-significant effects (using lmerTest version 3.1-3)
chla_full_model <- lmer(value ~ species * fpco2 * ftemp * reef + (1 | colony) + (1 | reef), data = chla_mod_df) # full model
chla_step <- step(chla_full_model) # run removal for best-fit model
chla_mod <- get_model(chla_step) # pull the final model
chla_mod_bestfit <- chla_mod@call[["formula"]] # pulls the model output
chla_mod_bestfit <- paste(format(chla_mod_bestfit))
chla_mod_bestfit <- paste0(chla_mod_bestfit[1], chla_mod_bestfit[2])
anova(chla_mod) # run anova on best fit model 

```

Since the best-fit model fits our design, we will proceed with the following model structure: 

**`r chla_mod_bestfit`**

```{r chlorophyll bootstrapping, eval=FALSE}

## mixed effect model run using lmer() (lmerTest version 3.1-3)
T90_df_model <- lmer(value ~ species + fpco2 + ftemp + reef + (1 | colony) + species:fpco2 + species:ftemp + fpco2:ftemp + species:reef, REML = TRUE, data = chla_mod_df)
out <- simulate(T90_df_model, nsim = bootnum, seed = seed, re.form = NULL) # simulate model chlorophyll response 2000 (bootnum) times (using random effects)
boots <- apply(out, 2, function(x) predict(lmer(x ~ species + fpco2 + ftemp + reef + (1 | colony) + species:fpco2 + species:ftemp + fpco2:ftemp + species:reef, REML = TRUE, data = chla_mod_df), re.form=NA)) # applies predict function on the columns (2) of the 'out' matrix created above from simulating the model 
boots <- cbind(predict(T90_df_model, re.form = NA), boots) # adds column to above df of predicted chlorophyll values without random effects
chla_mod_df_a <- (cbind(chla_mod_df, as.data.frame(t(apply(boots, 1, function(x) c(mean(x), quantile(x, c(0.025, 0.975)))))))) # apply function to calculate mean and 95% CI per sample based on the bootstrapped values, then add these to the actual values dataframe
colnames(chla_mod_df_a)[17:19] <- c("mean", "lowerci", "upperci") # rename columns with bootstrapped values

chla_df <- paste("LMER_model_outputs/Chlorophyll_model", date, sep="_") 
chla_df <- paste(chla_df, ".csv", sep="") 
write.csv(chla_mod_df_a, file = chla_df)  # last saved model was: Chlorophyll_model_2020-11-05.csv

```

<br/>
Figure:

```{r chlorophyll figure, fig.height = 2, fig.width = 10, fig.align = "center", results = 'hide', message=FALSE}

## load the chlorophyll bootstrapped model output
df_chla_a <- read.csv("LMER_model_outputs/Chlorophyll_model_2021-03-24.csv", head=T)
df_chla_a$ftemp <- as.factor(df_chla_a$ftemp)
df_chla_a$fpco2 <- as.factor(df_chla_a$fpco2)
df_chla_a$species <- factor(df_chla_a$species, levels = c("SSID", "PSTR", "PAST", "UTEN"))

## plot figure
chla_model_fig <- ggplot(df_chla_a)+
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), strip.text.x = element_blank(), panel.background=element_blank(), axis.line=element_line(color="black"), legend.key=element_blank(), strip.background = element_blank(), legend.position="none", panel.border = element_rect(colour = "black", size= 0.8))+
  scale_x_continuous(breaks = c(2, 4 ,6 ,8, 10), labels = c("T0", "300", "420", "680", "3300"))+
  geom_vline(xintercept = 3, size= 0.8)+
  ylab(clab)+
  xlab("")+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2)+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2, data = df_T0_chla) + # add T0 samples
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci, colour = ftemp), position = dodge, size = 1)+
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci), colour = "#009E73", position = dodge, size = 1, data = df_T0_chla)+ # add T0 CIs
  scale_color_manual("Temperature", values = c("#0072B2", "#D55E00", "#009E73"))+
  facet_wrap(~species, ncol = 3, scales = "free_y") +
  ggsave(paste0("Figures/Supplemental_Figures/Chlorophyll_boot_figure.pdf"), width = 10, height = 3)
chla_model_fig

```


#### Total Host 

```{r total host model selection, include=FALSE}

## run the full mixed-effects model for backwards removal of non-significant effects (using lmerTest version 3.1-3)
host_full_model <- lmer(value ~ species * fpco2 * ftemp * reef + (1 | colony) + (1 | reef), data = host_mod_df) # full model
host_step <- step(host_full_model) # run removal for best-fit model
host_mod <- get_model(host_step) # pull the final model
host_mod_bestfit <- host_mod@call[["formula"]] # pulls the model output 
host_mod_bestfit <- paste(format(host_mod_bestfit))
host_mod_bestfit <- paste0(host_mod_bestfit[1], host_mod_bestfit[2])
anova(host_mod) # run anova on best fit model 

```

Since the best-fit model fits our design, we will proceed with the following model structure: 

**`r host_mod_bestfit`**

```{r total host bootstrapping, eval=FALSE}

## mixed effect model run using lmer() (lmerTest version 3.1-3)
T90_df_model <- lmer(value ~ species + fpco2 + ftemp + reef + (1 | colony) + species:fpco2 + species:ftemp + species:reef + fpco2:reef + species:fpco2:reef, REML = TRUE, data = host_mod_df)
out <- simulate(T90_df_model, nsim = bootnum, seed = seed, re.form = NULL) # simulate model total host response 2000 (bootnum) times (using random effects)
boots <- apply(out, 2, function(x) predict(lmer(x ~ species + fpco2 + ftemp + reef + (1 | colony) + species:fpco2 + species:ftemp + species:reef + fpco2:reef + species:fpco2:reef, REML = TRUE, data = host_mod_df), re.form=NA)) # applies predict function on the columns (2) of the 'out' matrix created above from simulating the model 
boots <- cbind(predict(T90_df_model, re.form = NA), boots) # adds column to above df of predicted total host values without random effects
host_mod_df_a <- (cbind(host_mod_df, as.data.frame(t(apply(boots, 1, function(x) c(mean(x), quantile(x, c(0.025, 0.975)))))))) # apply function to calculate mean and 95% CI per sample based on the bootstrapped values, then add these to the actual values dataframe
colnames(host_mod_df_a)[17:19] <- c("mean", "lowerci", "upperci") # rename columns with bootstrapped values

host_df <- paste("LMER_model_outputs/TotalHost_model", date, sep="_") 
host_df <- paste(host_df, ".csv", sep="") 
write.csv(host_mod_df_a, file = host_df)  # last saved model was: TotalHost_model_2020-11-05.csv

```

<br/>
Figure:

```{r total host figure, fig.height = 2, fig.width = 10, fig.align = "center", results = 'hide', message=FALSE}

## load the host bootstrapped model output
df_host_a <- read.csv("LMER_model_outputs/TotalHost_model_2021-03-24.csv", head=T)
df_host_a$ftemp <- as.factor(df_host_a$ftemp)
df_host_a$fpco2 <- as.factor(df_host_a$fpco2)
df_host_a$species <- factor(df_host_a$species, levels = c("SSID", "PSTR", "PAST", "UTEN"))

## plot figure
host_model_fig <- ggplot(df_host_a)+
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), strip.text.x = element_blank(), panel.background=element_blank(), axis.line=element_line(color="black"), legend.key=element_blank(), strip.background = element_blank(), legend.position="none", panel.border = element_rect(colour = "black", size= 0.8))+
  scale_x_continuous(breaks = c(2, 4 ,6 ,8, 10), labels = c("T0", "300", "420", "680", "3300"))+
  geom_vline(xintercept = 3, size= 0.8)+
  ylab(hlab)+
  xlab("")+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2)+
  geom_point(aes(x = treat, y = value, colour = ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2, data = df_T0_host) + # add T0 samples
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci, colour = ftemp), position = dodge, size = 1)+
  geom_linerange(aes(x = treat, ymin = lowerci, ymax = upperci), colour = "#009E73", position = dodge, size = 1, data = df_T0_host)+ # add T0 CIs
  scale_color_manual("Temperature", values = c("#0072B2", "#D55E00", "#009E73"))+
  facet_wrap(~species, ncol = 3, scales = "free_y") +
  ggsave(paste0("Figures/Supplemental_Figures/TotalHost_boot_figure.pdf"), width = 10, height = 3)
host_model_fig

```





#### Calcification

*This is the same model from Bove et al 2019, just matching aesthetics for this manuscript.*

```{r calcification rate, fig.height = 2, fig.width = 10, fig.align = "center", results = 'hide', message=FALSE}

ncalc_a<-read.csv("Data/Raw_data/net_calc.csv")
#ncalc_a <- subset(ncalc_a, species != "T")
ncalc_a$ftemp <- as.factor(ncalc_a$ftemp)
ncalc_a$fpco2 <- as.factor(ncalc_a$fpco2)
ncalc_a <- subset(ncalc_a, species != "T")
ncalc_a$species <- factor(ncalc_a$species, levels = c("S", "P", "A"))

calc_model_fig <- ggplot(ncalc_a)+
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), strip.text.x = element_blank(), panel.background=element_blank(), axis.line=element_line(color="black"), legend.key=element_blank(), strip.background = element_blank(), legend.position="none", panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_hline(yintercept = 0, linetype = "dashed", colour = "grey") +
  #scale_x_continuous(breaks = ncalc_a$treat, labels = ncalc_a$fpco2)+
  ylab(rlab)+
  xlab("")+
  geom_point(aes(x = fpco2, y = rate, colour=ftemp), position = dodge2, alpha = 0.3, shape = 17, size = 2)+
  geom_linerange(aes(x = fpco2, ymin = lowerci, ymax = upperci, colour = ftemp), position = dodge, size = 1)+
  scale_color_manual("Temperature", values = c("#0072B2", "#D55E00", "#009E73"))+
  facet_wrap(~species, ncol = 4, scales = "free_y")

calc_model_fig

```


### Figure S1

```{r figure 3, fig.height = 10, fig.width = 10, fig.align = "center", results = 'hide', message=FALSE}

figS1 <- plot_grid(pro_model_fig, lipid_model_fig, carb_model_fig, den_model_fig, chla_model_fig, labels = "AUTO", ncol = 1, align = "v", axis = 'lb')
figS1

ggsave("Figures/Supplemental_Figures/FigureS1_physiology.pdf")

```

<br/>

**Figure S1.** Modeled 95% confidence interval of (**A**) host total protein (mg cm^-2^), (**B**) host total carbohydrate (mg cm^-2^), (**C**) host total lipid (mg cm^-2^), (**D**) cell density (10^6^ cells cm^-2^), and (**E**) Chlorophyll a (ug cm^-2^) for *S. siderea* (left), *P. strigosa* (center), and *P. astreoides* (right) at T0 (green) or T90 (<span style="color: #D55E00;">red</span>/<span style="color: #0072B2;">blue</span>), with individual coral fragment physiology denoted by points. <span style="color: #0072B2;">Blue</span> denotes 28&deg;C and <span style="color: #D55E00;">red</span> denotes 31&deg;C, with *p*CO~2~ treatment along the x axis.


<br/>
<br/>


## *S. siderea* gene expression subset {.tabset} 

### *SSID subset PCA*

```{r SSID subset PCA}

# set up the dataframe
s_df_sub <- s_df[!is.na(s_df$percent), ]

# run the adonis
#s_pca_mod <- adonis(value ~ reef * ftemp * fpco2 * domSymb, data = s_df_sub_l, method='eu') # below is the model with non sig interactions removed:
s_pca_sub_mod <- adonis2(s_df_sub[,c(14:17,21:23,29)] ~  fpco2 + fpco2:domSymb + domSymb + ftemp, data = s_df_sub, method = 'eu', permutations = bootnum)
s_pca_sub_mod # view SSID adonis output

# extract pvalues
s_sub_pval <- s_pca_sub_mod["Pr(>F)"]

# perform principal component analysis (PCA)
s_sub_pca <- prcomp(s_df_sub[,c(14:17,21:23,29)], center = TRUE, scale= TRUE)

```

```{r SSID subset PCA plot, fig.height=8, fig.width=8}

# create labels for p values calculated above
s_sub_reef_pval <-substitute(italic(P[reef])==p, list(p = format(s_sub_pval[1,1], digits = 2)))
s_sub_temp_pval <-substitute(italic(P[temp])==p, list(p = format(s_sub_pval[1,2], digits = 3)))
s_sub_pco2_pval <-substitute(italic(P[pCO[2]])==p, list(p = format(s_sub_pval[1,3], digits = 2)))

# reef environment
s_sub_reef_pca <- autoplot(s_sub_pca, data = s_df_sub, 
         colour = "domSymb",
         frame = TRUE, 
         frame.type = "norm",
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 3, 
         loadings.label.vjust = 1,
         loadings.label.repel = TRUE) +
  #scale_colour_manual("reef environment", labels = c("offshore", "inshore"), values = c("#00a08b", "#e9aa2b")) +
  #scale_fill_manual("reef environment", labels = c("offshore", "inshore"), values = c(NA, NA)) +  
  #lims(x = c(-0.5,0.4), y = c(-0.6,0.5)) +
  guides(col = guide_legend(nrow = 2, byrow = TRUE, title.position = "top")) +  
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(),strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.position = "none") +
  #annotate("text", x = -0.39, y = -0.38, label = deparse(s_sub_reef_pval), parse = TRUE, size = 3) +
  ggtitle("Dominant symbiont")

# temperature
s_sub_temp_pca <- autoplot(s_sub_pca, data = s_df_sub, 
         colour = "ftemp",
         shape = "treat2",
         frame = TRUE, 
         frame.type = "norm",
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 3, 
         loadings.label.vjust = 1,
         loadings.label.repel = TRUE) +
  scale_colour_manual("temperature", labels = c("28C", "31C"), values = c("#0072B2", "#D55E00"))+
  scale_fill_manual("temperature", labels = c("28C", "31C"), values = c(NA, NA))+
  lims(x = c(-0.5,0.4), y = c(-0.4,0.5)) +
  scale_shape_manual("pCO2", labels = c("pre industrial", "pre industrial", "current", "current", "end-of-century","end-of-century", "extreme", "extreme"), values = c(0,15,1,19,2,17,5,18))+
  guides(shape = FALSE, col = guide_legend(nrow = 2, byrow = TRUE, title.position = "top"))+  
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(),strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.position = "none") +
  #annotate("text", x = -0.34, y = -0.38, label = deparse(s_sub_temp_pval), parse = TRUE, size = 3) +  
  ggtitle("Temperature")

# pco2
s_sub_pco2_pca <- autoplot(s_sub_pca, data = s_df_sub, 
         colour = "fpco2",
         shape = "treat2",
         frame = TRUE, 
         frame.type = "norm",
         loadings = TRUE, 
         loadings.colour = "black", 
         loadings.label = TRUE,
         loadings.label.colour = "black",         
         loadings.label.size = 4, 
         loadings.label.hjust = 3, 
         loadings.label.vjust = 1,
         loadings.label.repel = TRUE) +
    scale_colour_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c("#b2abd2", "#5e3c99", "#fdb863", "#e66101"))+
    scale_fill_manual("pCO2", labels = c("pre industrial", "current", "end-of-century", "extreme"), values = c(NA, NA, NA, NA))+
    lims(x = c(-0.5,0.5), y = c(-0.6,0.6)) +   
    scale_shape_manual("temperature", labels = c("28C", "31C", "28C", "31C", "28C", "31C", "28C", "31C"), values = c(0,15,1,19,2,17,5,18))+
    guides(shape = FALSE, col = guide_legend(nrow = 2, byrow = TRUE, title.position = "top"))+
    theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(),strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1), legend.position = "none") +
  #annotate("text", x = -0.365, y = -0.38, label = deparse(s_sub_pco2_pval), parse = TRUE, size = 3) +   
  ggtitle("Acidification")


plot_grid(s_sub_temp_pca, s_sub_pco2_pca, s_sub_reef_pca, ncol = 3, scale = 0.8) + # markdown figure
    ggsave("Figures/Supplemental_Figures/SSID_subset_PCA_09Mar21.pdf", width = 18, height = 5)

SSID_plot <- plot_grid(s_temp_pca, s_pco2_pca, s_reef_pca, ncol = 3, scale = 0.8) # for final figure

```

---

<br/>
<br/>


### *Siderastrea siderea* subset

```{r SSID subset corr plot, eval=FALSE, include=FALSE}

## Subset for SSID GE samples only (with symb genus data)
sid_df_sub <- sid_df[(!is.na(sid_df$percent)),] 

## create a C dom and D dom dataframe
sid_corr_D <- sid_df_sub[sid_df_sub$domSymb == "D",] 
sid_corr_C <- sid_df_sub[sid_df_sub$domSymb == "C",]

## create matrix for correlations 
sid_corr_df_sub <- rcorr(as.matrix(sid_df_sub[, c(4,9,10,3,5,8,6)])) # from these correlations, going to stick with red channel for corr/PCA input
sid_corr_df_sub$r[sid_corr_df_sub$r < 0] <- 0 # this just makes negative correlations 0 since none are significant (easier for plotting)

sid_corr_df_C <- rcorr(as.matrix(sid_corr_C[, c(4,9,10,3,5,8,6)])) # from these correlations, going to stick with red channel for corr/PCA input
sid_corr_df_C$r[sid_corr_df_C$r < 0] <- 0 # this just makes negative correlations 0 since none are significant (easier for plotting)

sid_corr_df_D <- rcorr(as.matrix(sid_corr_D[, c(4,9,10,3,5,8,6)])) # from these correlations, going to stick with red channel for corr/PCA input
sid_corr_df_D$r[sid_corr_df_D$r < 0] <- 0 # this just makes negative correlations 0 since none are significant (easier for plotting)

## Rmarkdown plotting version
par(mfrow=c(1,3))
corrplot(sid_corr_df_sub$r, method = "ellipse", type = "upper", col = wes_palette("Zissou1", 7, type = "continuous"), number.cex = 0.8, p.mat = sid_corr_df_sub$P, sig.level = 0.05, insig = "blank", tl.col = "#0072B2", tl.cex = 1.1, title = expression(italic("S. siderea")), cl.lim = c(0,1), mar=c(0,0,1,0), cl.align.text = "l")

corrplot(sid_corr_df_C$r, method = "ellipse", type = "upper", col = wes_palette("Zissou1", 7, type = "continuous"), number.cex = 0.8, p.mat = sid_corr_df_C$P, sig.level = 0.05, insig = "blank", tl.col = "#0072B2", tl.cex = 1.1, title = expression(italic("S. siderea - Cladocopium")), cl.lim = c(0,1), mar=c(0,0,1,0), cl.align.text = "l")

corrplot(sid_corr_df_D$r, method = "ellipse", type = "upper", col = wes_palette("Zissou1", 7, type = "continuous"), number.cex = 0.8, p.mat = sid_corr_df_D$P, sig.level = 0.05, insig = "blank", tl.col = "#0072B2", tl.cex = 1.1, title = expression(italic("S. siderea - Durusdinium")), cl.lim = c(0,1), mar=c(0,0,1,0), cl.align.text = "l")

## save the symb sample corr plot
pdf(file = "Figures/Supplemental_Figures/CorrelationPlot_SSID_symbs.pdf", width = 12, height = 3)  

par(mfrow=c(1,3))
corrplot(sid_corr_df_sub$r, method = "ellipse", type = "upper", col = wes_palette("Zissou1", 7, type = "continuous"), number.cex = 0.8, p.mat = sid_corr_df_sub$P, sig.level = 0.05, insig = "blank", tl.col = "#0072B2", tl.cex = 1.1, title = expression(italic("S. siderea")), cl.lim = c(0,1), mar=c(0,0,1,0), cl.align.text = "l")

corrplot(sid_corr_df_C$r, method = "ellipse", type = "upper", col = wes_palette("Zissou1", 7, type = "continuous"), number.cex = 0.8, p.mat = sid_corr_df_C$P, sig.level = 0.05, insig = "blank", tl.col = "#0072B2", tl.cex = 1.1, title = expression(italic("S. siderea - Cladocopium")), cl.lim = c(0,1), mar=c(0,0,1,0), cl.align.text = "l")

corrplot(sid_corr_df_D$r, method = "ellipse", type = "upper", col = wes_palette("Zissou1", 7, type = "continuous"), number.cex = 0.8, p.mat = sid_corr_df_D$P, sig.level = 0.05, insig = "blank", tl.col = "#0072B2", tl.cex = 1.1, title = expression(italic("S. siderea - Durusdinium")), cl.lim = c(0,1), mar=c(0,0,1,0), cl.align.text = "l")

dev.off() 

par(mfrow = c(1, 1))

```



---

<br/>
<br/>


## Supplemental Tables{.tabset} 


```{r protein table}

df_pro_a$treat2 <- paste(df_pro_a$fpco2, df_pro_a$ftemp, sep = "_")
pro_tab <- df_pro_a[,c(9,21,18:20)] #subset for species, treatment, parameter, and model values
pro_tab$binder <- paste(pro_tab$species, pro_tab$treat2, sep = "_")

T90_pro_mean <- summarySE(data=pro_tab, measurevar = "mean", groupvars = c("species", "treat2", "binder"))
T90_pro_low <- summarySE(data=pro_tab, measurevar = "lowerci", groupvars = c("species", "treat2", "binder"))
T90_pro_up <- summarySE(data=pro_tab, measurevar = "upperci", groupvars = c("species", "treat2", "binder"))

pro_tab <- cbind(T90_pro_mean, T90_pro_low, T90_pro_up)[, c(1,2,4,5,13,21)]
pro_tab$mean <- round(pro_tab$mean, 2)
pro_tab$lowerci <- round(pro_tab$lowerci, 2)
pro_tab$upperci <- round(pro_tab$upperci, 2)

colnames(pro_tab)[colnames(pro_tab)=="treat2"] <- "treatment"
colnames(pro_tab)[colnames(pro_tab)=="lowerci"] <- "lower 95%"
colnames(pro_tab)[colnames(pro_tab)=="upperci"] <- "upper 95%"
pro_tab$treatment <- factor(pro_tab$treatment, c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31"))

table1 <- kable(pro_tab[,-c(1)], booktabs = T, caption = "Table 1. T90 modeled mean coral host protein content and 95% confidence intervals for each  species") %>%
  kable_styling(font_size = 10, full_width = F) %>% 
  pack_rows("(a) SSID", 1, 8) %>%
  pack_rows("(b) PSTR", 9, 16) %>%
  pack_rows("(c) PAST", 17, 24)
table1

```

```{r lipid table}

df_lipid_a$treat2 <- paste(df_lipid_a$fpco2, df_lipid_a$ftemp, sep = "_")
lipid_tab <- df_lipid_a[,c(9,21,18:20)] #subset for species, treatment, parameter, and model values
lipid_tab$binder <- paste(lipid_tab$species, lipid_tab$treat2, sep = "_")

T90_lipid_mean <- summarySE(data=lipid_tab, measurevar = "mean", groupvars = c("species", "treat2", "binder"))
T90_lipid_low <- summarySE(data=lipid_tab, measurevar = "lowerci", groupvars = c("species", "treat2", "binder"))
T90_lipid_up <- summarySE(data=lipid_tab, measurevar = "upperci", groupvars = c("species", "treat2", "binder"))

lipid_tab <- cbind(T90_lipid_mean, T90_lipid_low, T90_lipid_up)[, c(1,2,4,5,13,21)]
lipid_tab$mean <- round(lipid_tab$mean, 2)
lipid_tab$lowerci <- round(lipid_tab$lowerci, 2)
lipid_tab$upperci <- round(lipid_tab$upperci, 2)

colnames(lipid_tab)[colnames(lipid_tab)=="treat2"] <- "treatment"
colnames(lipid_tab)[colnames(lipid_tab)=="lowerci"] <- "lower 95%"
colnames(lipid_tab)[colnames(lipid_tab)=="upperci"] <- "upper 95%"
lipid_tab$treatment <- factor(lipid_tab$treatment, c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31"))

table2 <- kable(lipid_tab[,-c(1)], booktabs = T, caption = "Table 1. T90 modeled mean coral host lipid content and 95% confidence intervals for each  species") %>%
  kable_styling(font_size = 10, full_width = F) %>% 
  pack_rows("(a) SSID", 1, 8) %>%
  pack_rows("(b) PSTR", 9, 16) %>%
  pack_rows("(c) PAST", 17, 24)
table2

```

```{r carbohydrate table}

df_carb_a$treat2 <- paste(df_carb_a$fpco2, df_carb_a$ftemp, sep = "_")
carb_tab <- df_carb_a[,c(9,15,18:20)] #subset for species, treatment, parameter, and model values
carb_tab$binder <- paste(carb_tab$species, carb_tab$treat2, sep = "_")

T90_carb_mean <- summarySE(data=carb_tab, measurevar = "mean", groupvars = c("species", "treat2", "binder"))
T90_carb_low <- summarySE(data=carb_tab, measurevar = "lowerci", groupvars = c("species", "treat2", "binder"))
T90_carb_up <- summarySE(data=carb_tab, measurevar = "upperci", groupvars = c("species", "treat2", "binder"))

carb_tab <- cbind(T90_carb_mean, T90_carb_low, T90_carb_up)[, c(1,2,4,5,13,21)]
carb_tab$mean <- round(carb_tab$mean, 2)
carb_tab$lowerci <- round(carb_tab$lowerci, 2)
carb_tab$upperci <- round(carb_tab$upperci, 2)

colnames(carb_tab)[colnames(carb_tab)=="treat2"] <- "treatment"
colnames(carb_tab)[colnames(carb_tab)=="lowerci"] <- "lower 95%"
colnames(carb_tab)[colnames(carb_tab)=="upperci"] <- "upper 95%"
carb_tab$treatment <- factor(carb_tab$treatment, c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31"))

table3 <- kable(carb_tab[,-c(1)], booktabs = T, caption = "Table 1. T90 modeled mean coral host carbohydrate content and 95% confidence intervals for each  species") %>%
  kable_styling(font_size = 10, full_width = F) %>% 
  pack_rows("(a) SSID", 1, 8) %>%
  pack_rows("(b) PSTR", 9, 16) %>%
  pack_rows("(c) PAST", 17, 24)
table3

```

```{r density table}

df_den_a$treat2 <- paste(df_den_a$fpco2, df_den_a$ftemp, sep = "_")
den_tab <- df_den_a[,c(9,15,18:20)] #subset for species, treatment, parameter, and model values
den_tab$binder <- paste(den_tab$species, den_tab$treat2, sep = "_")

T90_den_mean <- summarySE(data=den_tab, measurevar = "mean", groupvars = c("species", "treat2", "binder"))
T90_den_low <- summarySE(data=den_tab, measurevar = "lowerci", groupvars = c("species", "treat2", "binder"))
T90_den_up <- summarySE(data=den_tab, measurevar = "upperci", groupvars = c("species", "treat2", "binder"))

den_tab <- cbind(T90_den_mean, T90_den_low, T90_den_up)[, c(1,2,4,5,13,21)]
den_tab$mean <- round(den_tab$mean, 2)
den_tab$lowerci <- round(den_tab$lowerci, 2)
den_tab$upperci <- round(den_tab$upperci, 2)

colnames(den_tab)[colnames(den_tab)=="treat2"] <- "treatment"
colnames(den_tab)[colnames(den_tab)=="lowerci"] <- "lower 95%"
colnames(den_tab)[colnames(den_tab)=="upperci"] <- "upper 95%"
den_tab$treatment <- factor(den_tab$treatment, c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31"))

table4 <- kable(den_tab[,-c(1)], booktabs = T, caption = "Table 1. T90 modeled mean coral symbiont density content and 95% confidence intervals for each  species") %>%
  kable_styling(font_size = 10, full_width = F) %>% 
  pack_rows("(a) SSID", 1, 8) %>%
  pack_rows("(b) PSTR", 9, 16) %>%
  pack_rows("(c) PAST", 17, 24)
table4

```

```{r chlorophyll table}

df_chla_a$treat2 <- paste(df_chla_a$fpco2, df_chla_a$ftemp, sep = "_")
chla_tab <- df_chla_a[,c(9,21,18:20)] #subset for species, treatment, parameter, and model values
chla_tab$binder <- paste(chla_tab$species, chla_tab$treat2, sep = "_")

T90_chla_mean <- summarySE(data=chla_tab, measurevar = "mean", groupvars = c("species", "treat2", "binder"))
T90_chla_low <- summarySE(data=chla_tab, measurevar = "lowerci", groupvars = c("species", "treat2", "binder"))
T90_chla_up <- summarySE(data=chla_tab, measurevar = "upperci", groupvars = c("species", "treat2", "binder"))

chla_tab <- cbind(T90_chla_mean, T90_chla_low, T90_chla_up)[, c(1,2,4,5,13,21)]
chla_tab$mean <- round(chla_tab$mean, 2)
chla_tab$lowerci <- round(chla_tab$lowerci, 2)
chla_tab$upperci <- round(chla_tab$upperci, 2)

colnames(chla_tab)[colnames(chla_tab)=="treat2"] <- "treatment"
colnames(chla_tab)[colnames(chla_tab)=="lowerci"] <- "lower 95%"
colnames(chla_tab)[colnames(chla_tab)=="upperci"] <- "upper 95%"
chla_tab$treatment <- factor(chla_tab$treatment, c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31"))

table5 <- kable(chla_tab[,-c(1)], booktabs = T, caption = "Table 1. T90 modeled mean coral symbiont chlorophyll a content and 95% confidence intervals for each  species") %>%
  kable_styling(font_size = 10, full_width = F) %>% 
  pack_rows("(a) SSID", 1, 8) %>%
  pack_rows("(b) PSTR", 9, 16) %>%
  pack_rows("(c) PAST", 17, 24)
table5

```

```{r host table}

df_host_a$treat2 <- paste(df_host_a$fpco2, df_host_a$ftemp, sep = "_")
host_tab <- df_host_a[,c(9,21,18:20)] #subset for species, treatment, parameter, and model values
host_tab$binder <- paste(host_tab$species, host_tab$treat2, sep = "_")

T90_host_mean <- summarySE(data=host_tab, measurevar = "mean", groupvars = c("species", "treat2", "binder"))
T90_host_low <- summarySE(data=host_tab, measurevar = "lowerci", groupvars = c("species", "treat2", "binder"))
T90_host_up <- summarySE(data=host_tab, measurevar = "upperci", groupvars = c("species", "treat2", "binder"))

host_tab <- cbind(T90_host_mean, T90_host_low, T90_host_up)[, c(1,2,4,5,13,21)]
host_tab$mean <- round(host_tab$mean, 2)
host_tab$lowerci <- round(host_tab$lowerci, 2)
host_tab$upperci <- round(host_tab$upperci, 2)

colnames(host_tab)[colnames(host_tab)=="treat2"] <- "treatment"
colnames(host_tab)[colnames(host_tab)=="lowerci"] <- "lower 95%"
colnames(host_tab)[colnames(host_tab)=="upperci"] <- "upper 95%"
host_tab$treatment <- factor(host_tab$treatment, c("300_28", "300_31", "420_28", "420_31", "680_28", "680_31", "3300_28", "3300_31"))

table6 <- kable(host_tab[,-c(1)], booktabs = T, caption = "Table 1. T90 modeled mean coral host energy reserves and 95% confidence intervals for each  species") %>%
  kable_styling(font_size = 10, full_width = F) %>% 
  pack_rows("(a) SSID", 1, 8) %>%
  pack_rows("(b) PSTR", 9, 16) %>%
  pack_rows("(c) PAST", 17, 24)
table6

```


```{r excel WB, message=FALSE, warning=FALSE}

### Create workbook
wb <- createWorkbook()

# add 'Table 1' worksheet
addWorksheet(wb, "Table 1 - protein") 
writeData(wb, sheet = 1, x = pro_tab)
setColWidths(wb, sheet = 1, cols = 1:5, widths = "auto")

# add 'Table 2' worksheet
addWorksheet(wb, "Table 2 - lipid") 
writeData(wb, sheet = 2, x = lipid_tab)
setColWidths(wb, sheet = 2, cols = 1:5, widths = "auto")

# add 'Table 3' worksheet
addWorksheet(wb, "Table 3 - carbohydrate") 
writeData(wb, sheet = 3, x = carb_tab)
setColWidths(wb, sheet = 3, cols = 1:5, widths = "auto")

# add 'Table 4' worksheet
addWorksheet(wb, "Table 4 - density") 
writeData(wb, sheet = 4, x = den_tab)
setColWidths(wb, sheet = 4, cols = 1:5, widths = "auto")

# add 'Table 5' worksheet
addWorksheet(wb, "Table 5 - chlorophyll") 
writeData(wb, sheet = 5, x = chla_tab)
setColWidths(wb, sheet = 5, cols = 1:5, widths = "auto")

# add 'Table 6' worksheet
addWorksheet(wb, "Table 6 - total host") 
writeData(wb, sheet = 6, x = host_tab)
setColWidths(wb, sheet = 6, cols = 1:5, widths = "auto")

# save workbook
saveWorkbook(wb, file="Data/Supplemental/Supplemental_Tables.xlsx", overwrite = TRUE)


```



<br/>


## Session information

Session information from the last run date on `r date`:

```{r}

sessionInfo()

```


